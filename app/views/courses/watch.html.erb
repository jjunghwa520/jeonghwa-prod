<% content_for :title, "#{@course.title} - ÏàòÍ∞ïÌïòÍ∏∞" %>

<div class="watch-container">
  <!-- ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ ÏòÅÏó≠ -->
  <div class="video-section bg-dark">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="video-player-wrapper">
            <!-- üìπ ÏòÅÏÉÅ Î∞∞ÏõÄÌÑ∞ - Ïã§Ï†ú ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ -->
            <div class="modern-video-player" style="position: relative;">
              <!-- ÎπÑÎîîÏò§ ÏóòÎ¶¨Î®ºÌä∏ -->
              <video 
                id="mainVideo" 
                class="w-100 h-100" 
                style="object-fit: contain; background: #000;"
                poster="<%= @course.thumbnail.presence || 'https://via.placeholder.com/1280x720/667eea/ffffff?text=üìπ+ÏòÅÏÉÅ+Î∞∞ÏõÄÌÑ∞' %>"
                preload="metadata"
                playsinline>
                <% if @video_url.present? %>
                  <% if @video_url.ends_with?(".m3u8") %>
                    <!-- HLSÎäî hls.jsÎ°ú attach ÏòàÏ†ï -->
                  <% else %>
                    <source src="<%= @video_url %>" type="video/mp4">
                  <% end %>
                <% else %>
                  <!-- Îç∞Î™® Ìè¥Î∞± -->
                  <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <% end %>
                <% Array(@subtitle_tracks).each_with_index do |track, idx| %>
                  <track src="<%= track.to_s.sub(Rails.root.join('public').to_s, '') %>" kind="subtitles" srclang="ko" label="ÌïúÍµ≠Ïñ¥" <%= 'default' if idx == 0 %>>
                <% end %>
                <p class="text-white text-center mt-5">Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎπÑÎîîÏò§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.</p>
              </video>

              <!-- Ïª§Ïä§ÌÖÄ ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§ -->
              <div class="video-controls" id="videoControls">
                <div class="controls-background"></div>
                
                <!-- ÏßÑÌñâÎ∞î -->
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-filled" id="progressFilled"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                  </div>
                  <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                  </div>
                </div>

                <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ -->
                <div class="control-buttons">
                  <div class="left-controls">
                    <button id="playPauseBtn" class="control-btn">
                      <i class="bi bi-play-fill"></i>
                    </button>
                    <button id="skipBackBtn" class="control-btn">
                      <i class="bi bi-skip-backward-fill"></i>
                    </button>
                    <button id="skipForwardBtn" class="control-btn">
                      <i class="bi bi-skip-forward-fill"></i>
                    </button>
                    <div class="volume-control">
                      <button id="muteBtn" class="control-btn">
                        <i class="bi bi-volume-up-fill"></i>
                      </button>
                      <input type="range" id="volumeSlider" min="0" max="100" value="100" class="volume-slider">
                    </div>
                  </div>

                  <div class="right-controls">
                    <div class="speed-control">
                      <select id="speedSelect" class="speed-select">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                      </select>
                    </div>
                    <button id="qualityBtn" class="control-btn">
                      <i class="bi bi-gear-fill"></i>
                    </button>
                    <button id="fullscreenBtn" class="control-btn">
                      <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                  </div>
                </div>

                <!-- Ï§ëÏïô Ïû¨ÏÉù Î≤ÑÌäº -->
                <div class="center-play-btn" id="centerPlayBtn">
                  <button class="center-play-button">
                    <i class="bi bi-play-fill"></i>
                  </button>
                </div>

                <!-- Î°úÎî© Ïä§ÌîºÎÑà -->
                <div class="loading-spinner" id="loadingSpinner">
                  <div class="spinner"></div>
                </div>
              </div>

              <!-- ÌîÑÎ¶¨Î∑∞ Í≤åÏù¥Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ -->
              <div id="previewGateOverlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.6); z-index:20; align-items:center; justify-content:center;">
                <div class="text-center text-white p-4">
                  <h5 class="mb-3">ÌîÑÎ¶¨Î∑∞Îäî 10%ÍπåÏßÄÎßå Í∞ÄÎä•Ìï©ÎãàÎã§</h5>
                  <div class="d-flex gap-2 justify-content-center">
                    <%= link_to "ÏàòÍ∞ïÏã†Ï≤≠", enroll_course_path(@course), data: { turbo_method: :post }, class: "btn btn-primary btn-lg" %>
                    <%= link_to "Í∞ïÏùò ÏÉÅÏÑ∏", course_path(@course), class: "btn btn-outline-light btn-lg" %>
                  </div>
                </div>
              </div>

              <!-- ÏòÅÏÉÅ Ï†ïÎ≥¥ Ïò§Î≤ÑÎ†àÏù¥ -->
              <div class="video-info-overlay" id="videoInfo">
                <div class="video-title">
                  <h4><%= @course.title %></h4>
                  <p><%= @course.instructor.name %> Í∞ïÏÇ¨</p>
                </div>
                <div class="lesson-info">
                  <span class="badge bg-primary">1Í∞ï. Í∞ïÏùò ÏÜåÍ∞ú</span>
                  <span class="lesson-duration">15:30</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Í∞ïÏùò Ï†ïÎ≥¥ Î∞è Ïª®ÌÖêÏ∏† ÏòÅÏó≠ -->
  <div class="content-section bg-light">
    <div class="container-fluid">
      <div class="row">
        <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
        <div class="col-lg-8">
          <div class="p-4">
            <!-- Í∞ïÏùò Ìó§Îçî -->
            <div class="d-flex align-items-center mb-3">
              <%= link_to @course, class: "btn btn-outline-secondary me-3" do %>
                <i class="bi bi-arrow-left"></i> Í∞ïÏùòÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
              <% end %>
              <div>
                <h4 class="mb-1"><%= @course.title %></h4>
                <p class="text-muted mb-0">
                  <i class="bi bi-person"></i> <%= @course.instructor.name %> Í∞ïÏÇ¨
                </p>
              </div>
            </div>

            <!-- ÏßÑÎèÑ Î∞î -->
            <div class="progress mb-4" style="height: 8px;">
              <% progress_value = (@enrollment&.progress || 0) %>
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: <%= progress_value %>%" 
                   aria-valuenow="<%= progress_value %>" 
                   aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <div class="d-flex justify-content-between text-muted small mb-4">
              <span>ÏßÑÎèÑÏú®: <%= @enrollment&.progress || 0 %>%</span>
              <span>
                <% if @enrollment&.completed? %>
                  <i class="bi bi-check-circle text-success"></i> ÏôÑÎ£å
                <% else %>
                  <% if @enrollment %>
                    <i class="bi bi-clock"></i> ÏàòÍ∞ï Ï§ë
                  <% else %>
                    <i class="bi bi-lock"></i> ÎØ∏ÏàòÍ∞ï
                  <% end %>
                <% end %>
              </span>
            </div>

            <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
            <ul class="nav nav-tabs" id="watchTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                  Í∞úÏöî
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                  ÎÖ∏Ìä∏
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="qna-tab" data-bs-toggle="tab" data-bs-target="#qna" type="button" role="tab">
                  Q&A
                </button>
              </li>
            </ul>

            <!-- ÌÉ≠ Ïª®ÌÖêÏ∏† -->
            <div class="tab-content" id="watchTabContent">
              <!-- Í∞úÏöî ÌÉ≠ -->
              <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="p-3">
                  <h5>Í∞ïÏùò ÏÑ§Î™Ö</h5>
                  <p><%= simple_format(@course.description) %></p>
                  
                  <div class="row mt-4">
                    <div class="col-md-6">
                      <h6>Í∞ïÏùò Ï†ïÎ≥¥</h6>
                      <ul class="list-unstyled">
                        <li><strong>Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> <%= @course.category %></li>
                        <li><strong>ÎÇúÏù¥ÎèÑ:</strong> 
                          <%= case @course.level
                              when 'beginner' then 'Ï¥àÍ∏â'
                              when 'intermediate' then 'Ï§ëÍ∏â'
                              when 'advanced' then 'Í≥†Í∏â'
                              end %>
                        </li>
                        <li><strong>ÏòàÏÉÅ ÏàòÍ∞ïÏãúÍ∞Ñ:</strong> <%= @course.duration %>ÏãúÍ∞Ñ</li>
                        <% if @enrollment&.enrolled_at %>
                          <li><strong>ÏàòÍ∞ï ÏãúÏûë:</strong> <%= @enrollment.enrolled_at.strftime("%YÎÖÑ %mÏõî %dÏùº") %></li>
                        <% end %>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h6>ÌïôÏäµ ÌÜµÍ≥Ñ</h6>
                      <ul class="list-unstyled">
                        <li><strong>Ï†ÑÏ≤¥ ÏàòÍ∞ïÏÉù:</strong> <%= @course.total_students %>Î™Ö</li>
                        <li><strong>ÌèâÍ∑† ÌèâÏ†ê:</strong> 
                          <span class="rating">
                            <% 5.times do |i| %>
                              <i class="bi bi-star<%= i < @course.average_rating ? '-fill' : '' %> text-warning"></i>
                            <% end %>
                          </span>
                          <%= @course.average_rating %>
                        </li>
                        <li><strong>Î¶¨Î∑∞ Ïàò:</strong> <%= @course.reviews.count %>Í∞ú</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ÎÖ∏Ìä∏ ÌÉ≠ -->
              <div class="tab-pane fade" id="notes" role="tabpanel">
                <div class="p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>ÌïôÏäµ ÎÖ∏Ìä∏</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#noteModal">
                      <i class="bi bi-plus"></i> ÎÖ∏Ìä∏ Ï∂îÍ∞Ä
                    </button>
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    ÌïôÏäµ ÎÖ∏Ìä∏ Í∏∞Îä•ÏùÄ Ìñ•ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ÏóêÏÑú Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.
                  </div>
                </div>
              </div>

              <!-- Q&A ÌÉ≠ -->
              <div class="tab-pane fade" id="qna" role="tabpanel">
                <div class="p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>ÏßàÎ¨∏Í≥º ÎãµÎ≥Ä</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#qnaModal">
                      <i class="bi bi-question-circle"></i> ÏßàÎ¨∏ÌïòÍ∏∞
                    </button>
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Q&A Í∏∞Îä•ÏùÄ Ìñ•ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ÏóêÏÑú Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î - Í∞ïÏùò Î™©Ï∞® -->
        <div class="col-lg-4 bg-white border-start">
          <div class="p-4">
            <h5 class="mb-3">Í∞ïÏùò Î™©Ï∞®</h5>
            
            <!-- ÏûÑÏãú Í∞ïÏùò Î™©Ï∞® -->
            <div class="curriculum-list">
              <div class="curriculum-section mb-3">
                <h6 class="text-muted">ÏÑπÏÖò 1: ÏãúÏûëÌïòÍ∏∞</h6>
                <div class="curriculum-item p-2 border rounded mb-2 bg-light">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">Í∞ïÏùò ÏÜåÍ∞ú</div>
                      <div class="text-muted" style="font-size: 0.8rem;">5Î∂Ñ</div>
                    </div>
                    <i class="bi bi-check-circle text-success"></i>
                  </div>
                </div>
                
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">Í∞úÎ∞ú ÌôòÍ≤Ω ÏÑ§Ï†ï</div>
                      <div class="text-muted" style="font-size: 0.8rem;">15Î∂Ñ</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="curriculum-section mb-3">
                <h6 class="text-muted">ÏÑπÏÖò 2: Í∏∞Ï¥à Í∞úÎÖê</h6>
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">Í∏∞Î≥∏ Î¨∏Î≤ï</div>
                      <div class="text-muted" style="font-size: 0.8rem;">25Î∂Ñ</div>
                    </div>
                  </div>
                </div>
                
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-text text-muted me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">Ïã§Ïäµ ÏûêÎ£å</div>
                      <div class="text-muted" style="font-size: 0.8rem;">PDF</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Í∞ïÏùò ÏôÑÎ£å Î≤ÑÌäº -->
            <div class="mt-4">
              <% if @enrollment&.completed? %>
                <div class="alert alert-success text-center">
                  <i class="bi bi-trophy"></i>
                  <strong>Í∞ïÏùò ÏôÑÎ£å!</strong><br>
                  ÏàòÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§.
                </div>
              <% else %>
                <button class="btn btn-success w-100" onclick="completeCourse()">
                  <i class="bi bi-check-circle"></i> Í∞ïÏùò ÏôÑÎ£åÌïòÍ∏∞
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.watch-container {
  margin-top: 0;
}

.curriculum-item:hover {
  background-color: #f8f9fa !important;
  cursor: pointer;
}

.curriculum-item.active {
  background-color: #e3f2fd !important;
  border-color: #2196f3 !important;
}

/* üé• Î™®Îçò ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Ïä§ÌÉÄÏùº */
.modern-video-player {
  background: #000;
  border-radius: 0;
  overflow: hidden;
  position: relative;
  cursor: none;
  transition: cursor 0.3s ease;
}

/* ÌîåÎ†àÏù¥Ïñ¥ ÎÜíÏù¥: ÏÉÅÎã® UIÎ•º Í≥†Î†§Ìï¥ Ìïú ÌôîÎ©¥ÏóêÏÑú Í∞úÏöî/Î™©Ï∞® ÏùºÎ∂ÄÍπåÏßÄ Î≥¥Ïù¥ÎèÑÎ°ù Ï°∞Ï†ï */
.modern-video-player { height: calc(100svh - 200px) !important; min-height: 460px; }
@media (max-width: 1200px){ .modern-video-player { height: calc(100svh - 260px) !important; min-height: 380px; } }
@media (max-width: 992px){ .modern-video-player { height: calc(100svh - 300px) !important; min-height: 320px; } }

.modern-video-player:hover {
  cursor: default;
}

.modern-video-player video {
  border-radius: 0;
}

/* ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§ */
.video-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background: linear-gradient(transparent, rgba(0,0,0,0.8));
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  z-index: 10;
}

.modern-video-player:hover .video-controls {
  opacity: 1;
  transform: translateY(0);
}

.controls-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  z-index: -1;
}

/* ÏßÑÌñâÎ∞î */
.progress-container {
  margin-bottom: 15px;
}

.progress-bar {
  height: 6px;
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
  position: relative;
  cursor: pointer;
  margin-bottom: 8px;
}

.progress-filled {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s ease;
}

.progress-handle {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  left: 0%;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.progress-bar:hover .progress-handle {
  opacity: 1;
}

.time-display {
  color: white;
  font-size: 14px;
  font-weight: 500;
}

/* Ïª®Ìä∏Î°§ Î≤ÑÌäº */
.control-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.left-controls, .right-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.control-btn {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
}

.control-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

/* Î≥ºÎ•® Ïª®Ìä∏Î°§ */
.volume-control {
  display: flex;
  align-items: center;
  gap: 8px;
}

.volume-slider {
  width: 80px;
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
  cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  cursor: pointer;
}

/* ÏÜçÎèÑ ÏÑ†ÌÉù */
.speed-select {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

.speed-select option {
  background: #333;
  color: white;
}

/* Ï§ëÏïô Ïû¨ÏÉù Î≤ÑÌäº */
.center-play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5;
  opacity: 1;
  transition: opacity 0.3s ease;
}

.center-play-button {
  background: rgba(0,0,0,0.7);
  border: none;
  color: white;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  font-size: 32px;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
}

.center-play-button:hover {
  background: rgba(0,0,0,0.9);
  transform: scale(1.1);
}

/* Î°úÎî© Ïä§ÌîºÎÑà */
.loading-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 15;
  display: none;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ÏòÅÏÉÅ Ï†ïÎ≥¥ Ïò§Î≤ÑÎ†àÏù¥ */
.video-info-overlay {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  color: white;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  z-index: 5;
}

.modern-video-player:hover .video-info-overlay {
  opacity: 1;
  transform: translateY(0);
}

.video-title h4 {
  margin: 0 0 5px 0;
  font-size: 20px;
  font-weight: 600;
}

.video-title p {
  margin: 0;
  font-size: 14px;
  opacity: 0.8;
}

.lesson-info {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.lesson-duration {
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  backdrop-filter: blur(5px);
}

/* Î∞òÏùëÌòï */
@media (max-width: 768px) {
  .video-controls {
    padding: 15px;
  }
  
  .control-buttons {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .left-controls, .right-controls {
    gap: 8px;
  }
  
  .control-btn {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }
  
  .center-play-button {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
  
  .volume-slider {
    width: 60px;
  }
}
</style>

<script>
// üé• ÏòÅÏÉÅ Î∞∞ÏõÄÌÑ∞ - Î™®Îçò ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ JavaScript
function initWatch(){
  const video = document.getElementById('mainVideo');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const centerPlayBtn = document.getElementById('centerPlayBtn');
  const skipBackBtn = document.getElementById('skipBackBtn');
  const skipForwardBtn = document.getElementById('skipForwardBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const speedSelect = document.getElementById('speedSelect');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const progressBar = document.querySelector('.progress-bar');
  const progressFilled = document.getElementById('progressFilled');
  const progressHandle = document.getElementById('progressHandle');
  const currentTimeSpan = document.getElementById('currentTime');
  const totalTimeSpan = document.getElementById('totalTime');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const videoControls = document.getElementById('videoControls');
  const videoPlayer = document.querySelector('.modern-video-player');

  let isPlaying = false;
  let controlsTimeout;

  // Ïù¥Ïñ¥Î≥¥Í∏∞/10% Í≤åÏù¥Ìä∏ Î≥ÄÏàò
  const isEnrolled = <%= @is_enrolled ? 'true' : 'false' %>;
  const courseId = <%= @course.id %>;
  const watchKey = `watch:${courseId}:position`;

  // Í∏∞Ï°¥ HLS Ï†ïÎ¶¨
  try { if (window.__hls && window.__hls.destroy) { window.__hls.destroy(); } } catch(e) {}
  window.__hls = null;

  // HLS attach if needed
  const videoUrl = '<%= @video_url.to_s %>';
  if (videoUrl && videoUrl.endsWith('.m3u8')) {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
    s.onload = () => {
      if (window.Hls && window.Hls.isSupported()) {
        const hls = new window.Hls();
        window.__hls = hls;
        hls.loadSource(videoUrl);
        hls.attachMedia(video);
        // attach ÏßÄÏó∞ ÎåÄÎπÑ Ìè¥Î∞± ÌÉÄÏù¥Î®∏: 2Ï¥à ÎÇ¥ ready ÏïàÎêòÎ©¥ nativeÎ°ú ÏãúÎèÑ
        setTimeout(()=>{
          if (video.readyState < 2 && video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoUrl;
          }
        }, 2000);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoUrl;
      }
    };
    document.head.appendChild(s);
  }

  // ÎπÑÎîîÏò§ Î°úÎìú ÏôÑÎ£å
  video.addEventListener('loadedmetadata', function() {
    totalTimeSpan.textContent = formatTime(video.duration);
    loadingSpinner.style.display = 'none';
    const saved = parseFloat(localStorage.getItem(watchKey) || '0');
    if (!isNaN(saved) && saved > 0 && saved < video.duration) {
      video.currentTime = saved;
    }
  });

  // Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ ÌÜ†Í∏Ä
  function togglePlayPause() {
    if (video.paused) {
      video.play();
      isPlaying = true;
      playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
      centerPlayBtn.style.opacity = '0';
      centerPlayBtn.style.pointerEvents = 'none';
    } else {
      video.pause();
      isPlaying = false;
      playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
      centerPlayBtn.style.opacity = '1';
      centerPlayBtn.style.pointerEvents = 'all';
    }
  }

  // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà (Ï§ëÎ≥µ Î∞©ÏßÄ ÏúÑÌï¥ ÏßÅÏ†ë Ìï†Îãπ)
  playPauseBtn.onclick = togglePlayPause;
  centerPlayBtn.onclick = togglePlayPause;
  video.onclick = togglePlayPause;

  // Ïä§ÌÇµ Í∏∞Îä•
  skipBackBtn.onclick = function() {
    video.currentTime = Math.max(0, video.currentTime - 10);
  };

  skipForwardBtn.onclick = function() {
    video.currentTime = Math.min(video.duration, video.currentTime + 10);
  };

  // ÏùåÏÜåÍ±∞ ÌÜ†Í∏Ä
  muteBtn.onclick = function() {
    if (video.muted) {
      video.muted = false;
      muteBtn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
      volumeSlider.value = video.volume * 100;
    } else {
      video.muted = true;
      muteBtn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
    }
  };

  // Î≥ºÎ•® Ï°∞Ï†à
  volumeSlider.addEventListener('input', function() {
    video.volume = this.value / 100;
    video.muted = false;
    
    if (video.volume === 0) {
      muteBtn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
    } else if (video.volume < 0.5) {
      muteBtn.innerHTML = '<i class="bi bi-volume-down-fill"></i>';
    } else {
      muteBtn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
    }
  });

  // Ïû¨ÏÉù ÏÜçÎèÑ Ï°∞Ï†à
  speedSelect.addEventListener('change', function() {
    video.playbackRate = parseFloat(this.value);
  });

  // Ï†ÑÏ≤¥ÌôîÎ©¥ ÌÜ†Í∏Ä
  fullscreenBtn.onclick = function() {
    if (!document.fullscreenElement) {
      videoPlayer.requestFullscreen().catch(err => {
        console.log('Ï†ÑÏ≤¥ÌôîÎ©¥ Ïò§Î•ò:', err);
      });
    } else {
      document.exitFullscreen();
    }
  };

  // Ï†ÑÏ≤¥ÌôîÎ©¥ ÏÉÅÌÉú Î≥ÄÍ≤Ω Í∞êÏßÄ
  document.addEventListener('fullscreenchange', function() {
    if (document.fullscreenElement) {
      fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
    } else {
      fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
    }
  });

  // ÏßÑÌñâÎ∞î ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ïù¥Ïñ¥Î≥¥Í∏∞/ÌîÑÎ¶¨Î∑∞ Í≤åÏù¥Ìä∏
  video.addEventListener('timeupdate', function() {
    const progress = (video.currentTime / video.duration) * 100;
    progressFilled.style.width = progress + '%';
    progressHandle.style.left = progress + '%';
    currentTimeSpan.textContent = formatTime(video.currentTime);

    // Ïù¥Ïñ¥Î≥¥Í∏∞ Ï†ÄÏû•
    try { localStorage.setItem(watchKey, String(video.currentTime)); } catch(e) {}

    // 10% ÌîÑÎ¶¨Î∑∞ Í≤åÏù¥Ìä∏
    if (!isEnrolled && video.duration && video.currentTime >= video.duration * 0.10) {
      video.pause();
      const overlay = document.getElementById('previewGateOverlay');
      if (overlay) overlay.style.display = 'flex';
    }
  });

  // ÏßÑÌñâÎ∞î ÌÅ¥Î¶≠ÏúºÎ°ú ÌÉêÏÉâ
  progressBar.addEventListener('click', function(e) {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * video.duration;
    video.currentTime = newTime;
  });

  // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
  video.addEventListener('waiting', function() {
    loadingSpinner.style.display = 'block';
  });

  video.addEventListener('canplay', function() {
    loadingSpinner.style.display = 'none';
  });

  // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch(e.code) {
      case 'Space':
        e.preventDefault();
        togglePlayPause();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        video.currentTime = Math.max(0, video.currentTime - 10);
        break;
      case 'ArrowRight':
        e.preventDefault();
        video.currentTime = Math.min(video.duration, video.currentTime + 10);
        break;
      case 'ArrowUp':
        e.preventDefault();
        video.volume = Math.min(1, video.volume + 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'ArrowDown':
        e.preventDefault();
        video.volume = Math.max(0, video.volume - 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'KeyM':
        e.preventDefault();
        muteBtn.click();
        break;
      case 'KeyF':
        e.preventDefault();
        fullscreenBtn.click();
        break;
    }
  });

  // Ïª®Ìä∏Î°§ ÏûêÎèô Ïà®ÍπÄ
  function showControls() {
    videoControls.style.opacity = '1';
    videoControls.style.transform = 'translateY(0)';
    videoPlayer.style.cursor = 'default';
    
    clearTimeout(controlsTimeout);
    controlsTimeout = setTimeout(hideControls, 3000);
  }

  function hideControls() {
    if (!video.paused) {
      videoControls.style.opacity = '0';
      videoControls.style.transform = 'translateY(20px)';
      videoPlayer.style.cursor = 'none';
    }
  }

  videoPlayer.addEventListener('mousemove', showControls);
  videoPlayer.addEventListener('mouseleave', function() {
    if (!video.paused) {
      clearTimeout(controlsTimeout);
      controlsTimeout = setTimeout(hideControls, 1000);
    }
  });

  // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ Ìï®Ïàò
  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }

  // Ï¥àÍ∏∞ ÏÑ§Ï†ï
  video.volume = 1;
  volumeSlider.value = 100;
  
  console.log('üé• ÏòÅÏÉÅ Î∞∞ÏõÄÌÑ∞ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!');
}
document.addEventListener('DOMContentLoaded', function(){
  try { history.scrollRestoration = 'manual'; } catch(e) {}
  window.scrollTo(0,0);
  initWatch();
});
document.addEventListener('turbo:load', function(){
  try { history.scrollRestoration = 'manual'; } catch(e) {}
  window.scrollTo(0,0);
  initWatch();
});
document.addEventListener('turbo:before-render', function(){
  try { if (window.__hls && window.__hls.destroy) { window.__hls.destroy(); } } catch(e) {}
  window.__hls = null;
});

// Í∞ïÏùò ÏôÑÎ£å Ìï®Ïàò
function completeCourse() {
  if (confirm('Í∞ïÏùòÎ•º ÏôÑÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
    // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî AJAXÎ°ú ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    alert('Í∞ïÏùòÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! üéâ');
    location.reload();
  }
}
</script>

