<% content_for :title, "#{@course.title} - ìˆ˜ê°•í•˜ê¸°" %>

<div class="watch-container">
  <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì˜ì—­ -->
  <div class="video-section bg-dark">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="video-player-wrapper">
            <!-- ğŸ“¹ ì˜ìƒ ë°°ì›€í„° - ì‹¤ì œ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ -->
            <div class="modern-video-player" style="position: relative;">
              <!-- ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ -->
              <video 
                id="mainVideo" 
                class="w-100 h-100" 
                style="object-fit: contain; background: #000;"
                poster="<%= @course.thumbnail.presence || 'https://via.placeholder.com/1280x720/667eea/ffffff?text=ğŸ“¹+ì˜ìƒ+ë°°ì›€í„°' %>"
                preload="metadata"
                playsinline>
                <% if @video_url.present? %>
                  <% if @video_url.ends_with?(".m3u8") %>
                    <!-- HLSëŠ” hls.jsë¡œ attach ì˜ˆì • -->
                  <% else %>
                    <source src="<%= @video_url %>" type="video/mp4">
                  <% end %>
                <% else %>
                  <!-- ë°ëª¨ í´ë°± -->
                  <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <% end %>
                <% Array(@subtitle_tracks).each_with_index do |track, idx| %>
                  <track src="<%= track.to_s.sub(Rails.root.join('public').to_s, '') %>" kind="subtitles" srclang="ko" label="í•œêµ­ì–´" <%= 'default' if idx == 0 %>>
                <% end %>
                <p class="text-white text-center mt-5">ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
              </video>

              <!-- ì»¤ìŠ¤í…€ ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ -->
              <div class="video-controls" id="videoControls">
                <div class="controls-background"></div>
                
                <!-- ì§„í–‰ë°” -->
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-filled" id="progressFilled"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                  </div>
                  <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                  </div>
                </div>

                <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
                <div class="control-buttons">
                  <div class="left-controls">
                    <button id="playPauseBtn" class="control-btn">
                      <i class="bi bi-play-fill"></i>
                    </button>
                    <button id="skipBackBtn" class="control-btn">
                      <i class="bi bi-skip-backward-fill"></i>
                    </button>
                    <button id="skipForwardBtn" class="control-btn">
                      <i class="bi bi-skip-forward-fill"></i>
                    </button>
                    <div class="volume-control">
                      <button id="muteBtn" class="control-btn">
                        <i class="bi bi-volume-up-fill"></i>
                      </button>
                      <input type="range" id="volumeSlider" min="0" max="100" value="100" class="volume-slider">
                    </div>
                  </div>

                  <div class="right-controls">
                    <div class="speed-control">
                      <select id="speedSelect" class="speed-select">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                      </select>
                    </div>
                    <button id="qualityBtn" class="control-btn">
                      <i class="bi bi-gear-fill"></i>
                    </button>
                    <button id="fullscreenBtn" class="control-btn">
                      <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                  </div>
                </div>

                <!-- ì¤‘ì•™ ì¬ìƒ ë²„íŠ¼ -->
                <div class="center-play-btn" id="centerPlayBtn">
                  <button class="center-play-button">
                    <i class="bi bi-play-fill"></i>
                  </button>
                </div>

                <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
                <div class="loading-spinner" id="loadingSpinner">
                  <div class="spinner"></div>
                </div>
              </div>

              <!-- í”„ë¦¬ë·° ê²Œì´íŠ¸ ì˜¤ë²„ë ˆì´ -->
              <div id="previewGateOverlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.6); z-index:20; align-items:center; justify-content:center;">
                <div class="text-center text-white p-4">
                  <h5 class="mb-3">í”„ë¦¬ë·°ëŠ” 10%ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</h5>
                  <div class="d-flex gap-2 justify-content-center">
                    <%= link_to "ìˆ˜ê°•ì‹ ì²­", enroll_course_path(@course), data: { turbo_method: :post }, class: "btn btn-primary btn-lg" %>
                    <%= link_to "ê°•ì˜ ìƒì„¸", course_path(@course), class: "btn btn-outline-light btn-lg" %>
                  </div>
                </div>
              </div>

              <!-- ì˜ìƒ ì •ë³´ ì˜¤ë²„ë ˆì´ -->
              <div class="video-info-overlay" id="videoInfo">
                <div class="video-title">
                  <h4><%= @course.title %></h4>
                  <p><%= @course.instructor.name %> ê°•ì‚¬</p>
                </div>
                <div class="lesson-info">
                  <span class="badge bg-primary">1ê°•. ê°•ì˜ ì†Œê°œ</span>
                  <span class="lesson-duration">15:30</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê°•ì˜ ì •ë³´ ë° ì»¨í…ì¸  ì˜ì—­ -->
  <div class="content-section bg-light">
    <div class="container-fluid">
      <div class="row">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="col-lg-8">
          <div class="p-4">
            <!-- ê°•ì˜ í—¤ë” -->
            <div class="d-flex align-items-center mb-3">
              <%= link_to @course, class: "btn btn-outline-secondary me-3" do %>
                <i class="bi bi-arrow-left"></i> ê°•ì˜ë¡œ ëŒì•„ê°€ê¸°
              <% end %>
              <div>
                <h4 class="mb-1"><%= @course.title %></h4>
                <p class="text-muted mb-0">
                  <i class="bi bi-person"></i> <%= @course.instructor.name %> ê°•ì‚¬
                </p>
              </div>
            </div>

            <!-- ì§„ë„ ë°” -->
            <div class="progress mb-4" style="height: 8px;">
              <% progress_value = (@enrollment&.progress || 0) %>
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: <%= progress_value %>%" 
                   aria-valuenow="<%= progress_value %>" 
                   aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <div class="d-flex justify-content-between text-muted small mb-4">
              <span>ì§„ë„ìœ¨: <%= @enrollment&.progress || 0 %>%</span>
              <span>
                <% if @enrollment&.completed? %>
                  <i class="bi bi-check-circle text-success"></i> ì™„ë£Œ
                <% else %>
                  <% if @enrollment %>
                    <i class="bi bi-clock"></i> ìˆ˜ê°• ì¤‘
                  <% else %>
                    <i class="bi bi-lock"></i> ë¯¸ìˆ˜ê°•
                  <% end %>
                <% end %>
              </span>
            </div>

            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <ul class="nav nav-tabs" id="watchTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                  ê°œìš”
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                  ë…¸íŠ¸
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="qna-tab" data-bs-toggle="tab" data-bs-target="#qna" type="button" role="tab">
                  Q&A
                </button>
              </li>
            </ul>

            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="tab-content" id="watchTabContent">
              <!-- ê°œìš” íƒ­ -->
              <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="p-3">
                  <h5>ê°•ì˜ ì„¤ëª…</h5>
                  <p><%= simple_format(@course.description) %></p>
                  
                  <div class="row mt-4">
                    <div class="col-md-6">
                      <h6>ê°•ì˜ ì •ë³´</h6>
                      <ul class="list-unstyled">
                        <li><strong>ì¹´í…Œê³ ë¦¬:</strong> <%= @course.category %></li>
                        <li><strong>ë‚œì´ë„:</strong> 
                          <%= case @course.level
                              when 'beginner' then 'ì´ˆê¸‰'
                              when 'intermediate' then 'ì¤‘ê¸‰'
                              when 'advanced' then 'ê³ ê¸‰'
                              end %>
                        </li>
                        <li><strong>ì˜ˆìƒ ìˆ˜ê°•ì‹œê°„:</strong> <%= @course.duration %>ì‹œê°„</li>
                        <% if @enrollment&.enrolled_at %>
                          <li><strong>ìˆ˜ê°• ì‹œì‘:</strong> <%= @enrollment.enrolled_at.strftime("%Yë…„ %mì›” %dì¼") %></li>
                        <% end %>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h6>í•™ìŠµ í†µê³„</h6>
                      <ul class="list-unstyled">
                        <li><strong>ì „ì²´ ìˆ˜ê°•ìƒ:</strong> <%= @course.total_students %>ëª…</li>
                        <li><strong>í‰ê·  í‰ì :</strong> 
                          <span class="rating">
                            <% 5.times do |i| %>
                              <i class="bi bi-star<%= i < @course.average_rating ? '-fill' : '' %> text-warning"></i>
                            <% end %>
                          </span>
                          <%= @course.average_rating %>
                        </li>
                        <li><strong>ë¦¬ë·° ìˆ˜:</strong> <%= @course.reviews.count %>ê°œ</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ë…¸íŠ¸ íƒ­ -->
              <div class="tab-pane fade" id="notes" role="tabpanel">
                <div class="p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>í•™ìŠµ ë…¸íŠ¸</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#noteModal">
                      <i class="bi bi-plus"></i> ë…¸íŠ¸ ì¶”ê°€
                    </button>
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    í•™ìŠµ ë…¸íŠ¸ ê¸°ëŠ¥ì€ í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.
                  </div>
                </div>
              </div>

              <!-- Q&A íƒ­ -->
              <div class="tab-pane fade" id="qna" role="tabpanel">
                <div class="p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>ì§ˆë¬¸ê³¼ ë‹µë³€</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#qnaModal">
                      <i class="bi bi-question-circle"></i> ì§ˆë¬¸í•˜ê¸°
                    </button>
                  </div>
                  
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Q&A ê¸°ëŠ¥ì€ í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì‚¬ì´ë“œë°” - ê°•ì˜ ëª©ì°¨ -->
        <div class="col-lg-4 bg-white border-start">
          <div class="p-4">
            <h5 class="mb-3">ê°•ì˜ ëª©ì°¨</h5>
            
            <!-- ì„ì‹œ ê°•ì˜ ëª©ì°¨ -->
            <div class="curriculum-list">
              <div class="curriculum-section mb-3">
                <h6 class="text-muted">ì„¹ì…˜ 1: ì‹œì‘í•˜ê¸°</h6>
                <div class="curriculum-item p-2 border rounded mb-2 bg-light">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">ê°•ì˜ ì†Œê°œ</div>
                      <div class="text-muted" style="font-size: 0.8rem;">5ë¶„</div>
                    </div>
                    <i class="bi bi-check-circle text-success"></i>
                  </div>
                </div>
                
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">ê°œë°œ í™˜ê²½ ì„¤ì •</div>
                      <div class="text-muted" style="font-size: 0.8rem;">15ë¶„</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="curriculum-section mb-3">
                <h6 class="text-muted">ì„¹ì…˜ 2: ê¸°ì´ˆ ê°œë…</h6>
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle text-primary me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">ê¸°ë³¸ ë¬¸ë²•</div>
                      <div class="text-muted" style="font-size: 0.8rem;">25ë¶„</div>
                    </div>
                  </div>
                </div>
                
                <div class="curriculum-item p-2 border rounded mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-text text-muted me-2"></i>
                    <div class="flex-grow-1">
                      <div class="small fw-semibold">ì‹¤ìŠµ ìë£Œ</div>
                      <div class="text-muted" style="font-size: 0.8rem;">PDF</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê°•ì˜ ì™„ë£Œ ë²„íŠ¼ -->
            <div class="mt-4">
              <% if @enrollment&.completed? %>
                <div class="alert alert-success text-center">
                  <i class="bi bi-trophy"></i>
                  <strong>ê°•ì˜ ì™„ë£Œ!</strong><br>
                  ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.
                </div>
              <% else %>
                <button class="btn btn-success w-100" onclick="completeCourse()">
                  <i class="bi bi-check-circle"></i> ê°•ì˜ ì™„ë£Œí•˜ê¸°
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.watch-container {
  margin-top: 0;
}

.curriculum-item:hover {
  background-color: #f8f9fa !important;
  cursor: pointer;
}

.curriculum-item.active {
  background-color: #e3f2fd !important;
  border-color: #2196f3 !important;
}

/* ğŸ¥ ëª¨ë˜ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
.modern-video-player {
  background: #000;
  border-radius: 0;
  overflow: hidden;
  position: relative;
  cursor: none;
  transition: cursor 0.3s ease;
}

/* í”Œë ˆì´ì–´ ë†’ì´: ìƒë‹¨ UIë¥¼ ê³ ë ¤í•´ í•œ í™”ë©´ì—ì„œ ê°œìš”/ëª©ì°¨ ì¼ë¶€ê¹Œì§€ ë³´ì´ë„ë¡ ì¡°ì • */
.modern-video-player { height: calc(100svh - 200px) !important; min-height: 460px; }
@media (max-width: 1200px){ .modern-video-player { height: calc(100svh - 260px) !important; min-height: 380px; } }
@media (max-width: 992px){ .modern-video-player { height: calc(100svh - 300px) !important; min-height: 320px; } }

.modern-video-player:hover {
  cursor: default;
}

.modern-video-player video {
  border-radius: 0;
}

/* ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ */
.video-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  background: linear-gradient(transparent, rgba(0,0,0,0.8));
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  z-index: 10;
}

.modern-video-player:hover .video-controls {
  opacity: 1;
  transform: translateY(0);
}

.controls-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  z-index: -1;
}

/* ì§„í–‰ë°” */
.progress-container {
  margin-bottom: 15px;
}

.progress-bar {
  height: 6px;
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
  position: relative;
  cursor: pointer;
  margin-bottom: 8px;
}

.progress-filled {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s ease;
}

.progress-handle {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  left: 0%;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.progress-bar:hover .progress-handle {
  opacity: 1;
}

.time-display {
  color: white;
  font-size: 14px;
  font-weight: 500;
}

/* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
.control-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.left-controls, .right-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.control-btn {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
}

.control-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

/* ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ */
.volume-control {
  display: flex;
  align-items: center;
  gap: 8px;
}

.volume-slider {
  width: 80px;
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
  cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  cursor: pointer;
}

/* ì†ë„ ì„ íƒ */
.speed-select {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

.speed-select option {
  background: #333;
  color: white;
}

/* ì¤‘ì•™ ì¬ìƒ ë²„íŠ¼ */
.center-play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5;
  opacity: 1;
  transition: opacity 0.3s ease;
}

.center-play-button {
  background: rgba(0,0,0,0.7);
  border: none;
  color: white;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  font-size: 32px;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
}

.center-play-button:hover {
  background: rgba(0,0,0,0.9);
  transform: scale(1.1);
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loading-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 15;
  display: none;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ì˜ìƒ ì •ë³´ ì˜¤ë²„ë ˆì´ */
.video-info-overlay {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  color: white;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  z-index: 5;
}

.modern-video-player:hover .video-info-overlay {
  opacity: 1;
  transform: translateY(0);
}

.video-title h4 {
  margin: 0 0 5px 0;
  font-size: 20px;
  font-weight: 600;
}

.video-title p {
  margin: 0;
  font-size: 14px;
  opacity: 0.8;
}

.lesson-info {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.lesson-duration {
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  backdrop-filter: blur(5px);
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .video-controls {
    padding: 15px;
  }
  
  .control-buttons {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .left-controls, .right-controls {
    gap: 8px;
  }
  
  .control-btn {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }
  
  .center-play-button {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
  
  .volume-slider {
    width: 60px;
  }
}
</style>

<script>
// ğŸ¥ ì˜ìƒ ë°°ì›€í„° - ëª¨ë˜ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ JavaScript
function initWatch(){
  const video = document.getElementById('mainVideo');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const centerPlayBtn = document.getElementById('centerPlayBtn');
  const skipBackBtn = document.getElementById('skipBackBtn');
  const skipForwardBtn = document.getElementById('skipForwardBtn');
  const muteBtn = document.getElementById('muteBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const speedSelect = document.getElementById('speedSelect');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const progressBar = document.querySelector('.progress-bar');
  const progressFilled = document.getElementById('progressFilled');
  const progressHandle = document.getElementById('progressHandle');
  const currentTimeSpan = document.getElementById('currentTime');
  const totalTimeSpan = document.getElementById('totalTime');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const videoControls = document.getElementById('videoControls');
  const videoPlayer = document.querySelector('.modern-video-player');

  let isPlaying = false;
  let controlsTimeout;

  // ì´ì–´ë³´ê¸°/10% ê²Œì´íŠ¸ ë³€ìˆ˜
  const isEnrolled = <%= @is_enrolled ? 'true' : 'false' %>;
  const courseId = <%= @course.id %>;
  const watchKey = `watch:${courseId}:position`;

  // ê¸°ì¡´ HLS ì •ë¦¬
  try { if (window.__hls && window.__hls.destroy) { window.__hls.destroy(); } } catch(e) {}
  window.__hls = null;

  // HLS attach if needed
  const videoUrl = '<%= @video_url.to_s %>';
  if (videoUrl && videoUrl.endsWith('.m3u8')) {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
    s.onload = () => {
      if (window.Hls && window.Hls.isSupported()) {
        const hls = new window.Hls();
        window.__hls = hls;
        hls.loadSource(videoUrl);
        hls.attachMedia(video);
        // attach ì§€ì—° ëŒ€ë¹„ í´ë°± íƒ€ì´ë¨¸: 2ì´ˆ ë‚´ ready ì•ˆë˜ë©´ nativeë¡œ ì‹œë„
        setTimeout(()=>{
          if (video.readyState < 2 && video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoUrl;
          }
        }, 2000);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoUrl;
      }
    };
    document.head.appendChild(s);
  }

  // ë¹„ë””ì˜¤ ë¡œë“œ ì™„ë£Œ
  video.addEventListener('loadedmetadata', function() {
    totalTimeSpan.textContent = formatTime(video.duration);
    loadingSpinner.style.display = 'none';
    const saved = parseFloat(localStorage.getItem(watchKey) || '0');
    if (!isNaN(saved) && saved > 0 && saved < video.duration) {
      video.currentTime = saved;
    }
  });

  // ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€
  function togglePlayPause() {
    if (video.paused) {
      video.play();
      isPlaying = true;
      playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
      centerPlayBtn.style.opacity = '0';
      centerPlayBtn.style.pointerEvents = 'none';
    } else {
      video.pause();
      isPlaying = false;
      playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
      centerPlayBtn.style.opacity = '1';
      centerPlayBtn.style.pointerEvents = 'all';
    }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ë°©ì§€ ìœ„í•´ ì§ì ‘ í• ë‹¹)
  playPauseBtn.onclick = togglePlayPause;
  centerPlayBtn.onclick = togglePlayPause;
  video.onclick = togglePlayPause;

  // ìŠ¤í‚µ ê¸°ëŠ¥
  skipBackBtn.onclick = function() {
    video.currentTime = Math.max(0, video.currentTime - 10);
  };

  skipForwardBtn.onclick = function() {
    video.currentTime = Math.min(video.duration, video.currentTime + 10);
  };

  // ìŒì†Œê±° í† ê¸€
  muteBtn.onclick = function() {
    if (video.muted) {
      video.muted = false;
      muteBtn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
      volumeSlider.value = video.volume * 100;
    } else {
      video.muted = true;
      muteBtn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
    }
  };

  // ë³¼ë¥¨ ì¡°ì ˆ
  volumeSlider.addEventListener('input', function() {
    video.volume = this.value / 100;
    video.muted = false;
    
    if (video.volume === 0) {
      muteBtn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
    } else if (video.volume < 0.5) {
      muteBtn.innerHTML = '<i class="bi bi-volume-down-fill"></i>';
    } else {
      muteBtn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
    }
  });

  // ì¬ìƒ ì†ë„ ì¡°ì ˆ
  speedSelect.addEventListener('change', function() {
    video.playbackRate = parseFloat(this.value);
  });

  // ì „ì²´í™”ë©´ í† ê¸€
  fullscreenBtn.onclick = function() {
    if (!document.fullscreenElement) {
      videoPlayer.requestFullscreen().catch(err => {
        console.log('ì „ì²´í™”ë©´ ì˜¤ë¥˜:', err);
      });
    } else {
      document.exitFullscreen();
    }
  };

  // ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ê°ì§€
  document.addEventListener('fullscreenchange', function() {
    if (document.fullscreenElement) {
      fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
    } else {
      fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
    }
  });

  // ì§„í–‰ë°” ì—…ë°ì´íŠ¸ ë° ì´ì–´ë³´ê¸°/í”„ë¦¬ë·° ê²Œì´íŠ¸
  video.addEventListener('timeupdate', function() {
    const progress = (video.currentTime / video.duration) * 100;
    progressFilled.style.width = progress + '%';
    progressHandle.style.left = progress + '%';
    currentTimeSpan.textContent = formatTime(video.currentTime);

    // ì´ì–´ë³´ê¸° ì €ì¥
    try { localStorage.setItem(watchKey, String(video.currentTime)); } catch(e) {}

    // 10% í”„ë¦¬ë·° ê²Œì´íŠ¸
    if (!isEnrolled && video.duration && video.currentTime >= video.duration * 0.10) {
      video.pause();
      const overlay = document.getElementById('previewGateOverlay');
      if (overlay) overlay.style.display = 'flex';
    }
  });

  // ì§„í–‰ë°” í´ë¦­ìœ¼ë¡œ íƒìƒ‰
  progressBar.addEventListener('click', function(e) {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * video.duration;
    video.currentTime = newTime;
  });

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  video.addEventListener('waiting', function() {
    loadingSpinner.style.display = 'block';
  });

  video.addEventListener('canplay', function() {
    loadingSpinner.style.display = 'none';
  });

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch(e.code) {
      case 'Space':
        e.preventDefault();
        togglePlayPause();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        video.currentTime = Math.max(0, video.currentTime - 10);
        break;
      case 'ArrowRight':
        e.preventDefault();
        video.currentTime = Math.min(video.duration, video.currentTime + 10);
        break;
      case 'ArrowUp':
        e.preventDefault();
        video.volume = Math.min(1, video.volume + 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'ArrowDown':
        e.preventDefault();
        video.volume = Math.max(0, video.volume - 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'KeyM':
        e.preventDefault();
        muteBtn.click();
        break;
      case 'KeyF':
        e.preventDefault();
        fullscreenBtn.click();
        break;
    }
  });

  // ì»¨íŠ¸ë¡¤ ìë™ ìˆ¨ê¹€
  function showControls() {
    videoControls.style.opacity = '1';
    videoControls.style.transform = 'translateY(0)';
    videoPlayer.style.cursor = 'default';
    
    clearTimeout(controlsTimeout);
    controlsTimeout = setTimeout(hideControls, 3000);
  }

  function hideControls() {
    if (!video.paused) {
      videoControls.style.opacity = '0';
      videoControls.style.transform = 'translateY(20px)';
      videoPlayer.style.cursor = 'none';
    }
  }

  videoPlayer.addEventListener('mousemove', showControls);
  videoPlayer.addEventListener('mouseleave', function() {
    if (!video.paused) {
      clearTimeout(controlsTimeout);
      controlsTimeout = setTimeout(hideControls, 1000);
    }
  });

  // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }

  // ì´ˆê¸° ì„¤ì •
  video.volume = 1;
  volumeSlider.value = 100;
  
  console.log('ğŸ¥ ì˜ìƒ ë°°ì›€í„° í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!');
}
document.addEventListener('DOMContentLoaded', function(){
  try { history.scrollRestoration = 'manual'; } catch(e) {}
  window.scrollTo(0,0);
  initWatch();
});
document.addEventListener('turbo:load', function(){
  try { history.scrollRestoration = 'manual'; } catch(e) {}
  window.scrollTo(0,0);
  initWatch();
});
document.addEventListener('turbo:before-render', function(){
  try { if (window.__hls && window.__hls.destroy) { window.__hls.destroy(); } } catch(e) {}
  window.__hls = null;
});

// ê°•ì˜ ì™„ë£Œ í•¨ìˆ˜
function completeCourse() {
  if (confirm('ê°•ì˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” AJAXë¡œ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
    alert('ê°•ì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
    location.reload();
  }
}
</script>

