<% content_for :title, "프로필 수정 - 정화의 서재" %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <div class="d-flex align-items-center">
            <%= link_to @user, class: "btn btn-outline-secondary me-3" do %>
              <i class="bi bi-arrow-left"></i>
            <% end %>
            <div>
              <h4 class="mb-0">프로필 수정</h4>
              <p class="text-muted mb-0">개인정보를 안전하게 관리하세요</p>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <%= form_with model: @user, local: true, class: "needs-validation", novalidate: true do |f| %>
            
            <!-- 프로필 이미지 섹션 -->
            <div class="mb-4 text-center">
              <div class="mb-3">
                <% if @user.avatar.present? %>
                  <%= image_tag @user.avatar, class: "rounded-circle", style: "width: 120px; height: 120px; object-fit: cover;" %>
                <% else %>
                  <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center text-white" style="width: 120px; height: 120px; font-size: 3rem;">
                    <%= @user.name.first.upcase %>
                  </div>
                <% end %>
              </div>
              
              <div class="mb-3">
                <%= f.label :avatar, "프로필 이미지 URL", class: "form-label" %>
                <%= f.url_field :avatar, class: "form-control", 
                                placeholder: "https://example.com/profile.jpg" %>
                <div class="form-text">프로필 이미지 URL을 입력하세요 (선택사항)</div>
              </div>
            </div>
            
            <!-- 기본 정보 섹션 -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">기본 정보</h5>
              
              <div class="mb-3">
                <%= f.label :name, "이름", class: "form-label fw-semibold" %>
                <%= f.text_field :name, class: "form-control", required: true %>
                <div class="form-text">실명 또는 활동명을 입력하세요 (2-50자)</div>
                <div class="invalid-feedback">이름을 입력해주세요.</div>
              </div>
              
              <div class="mb-3">
                <%= f.label :email, "이메일", class: "form-label fw-semibold" %>
                <%= f.email_field :email, class: "form-control", required: true %>
                <div class="form-text">로그인 시 사용되는 이메일 주소입니다</div>
                <div class="invalid-feedback">올바른 이메일을 입력해주세요.</div>
              </div>
              
              <div class="mb-3">
                <%= f.label :bio, "자기소개", class: "form-label fw-semibold" %>
                <%= f.text_area :bio, class: "form-control", rows: 4,
                                placeholder: "자신을 소개하는 글을 작성해주세요. 관심분야, 경험, 목표 등을 포함할 수 있습니다." %>
                <div class="form-text">다른 사용자들에게 보여질 자기소개입니다 (선택사항)</div>
              </div>
            </div>
            
            <!-- 비밀번호 변경 섹션 -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">비밀번호 변경</h5>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                비밀번호를 변경하지 않으려면 아래 필드들을 비워두세요.
              </div>
              
              <div class="mb-3">
                <%= f.label :password, "새 비밀번호", class: "form-label fw-semibold" %>
                <%= f.password_field :password, class: "form-control", 
                                    placeholder: "새 비밀번호를 입력하세요" %>
                <div class="form-text">최소 6자 이상 입력하세요</div>
              </div>
              
              <div class="mb-3">
                <%= f.label :password_confirmation, "비밀번호 확인", class: "form-label fw-semibold" %>
                <%= f.password_field :password_confirmation, class: "form-control", 
                                    placeholder: "비밀번호를 다시 입력하세요" %>
                <div class="form-text">위에서 입력한 비밀번호와 동일하게 입력하세요</div>
              </div>
            </div>
            
            <!-- 계정 정보 섹션 -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">계정 정보</h5>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                      <h5 class="text-primary">
                        <span class="badge bg-<%= @user.role == 'admin' ? 'danger' : @user.role == 'instructor' ? 'success' : 'primary' %>">
                          <%= case @user.role
                              when 'admin' then '관리자'
                              when 'instructor' then '강사'
                              else '학생'
                              end %>
                        </span>
                      </h5>
                      <p class="mb-0">현재 권한</p>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                      <h5 class="text-success"><%= @user.created_at.strftime("%Y년 %m월") %></h5>
                      <p class="mb-0">가입일</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <% if @user.role == 'student' %>
                <div class="mt-3">
                  <div class="alert alert-info">
                    <h6 class="alert-heading">💡 강사가 되어보세요!</h6>
                    <p class="mb-0">
                      지식을 공유하고 싶으시다면 강사 권한을 요청할 수 있습니다. 
                      관리자가 검토 후 승인해드립니다.
                    </p>
                    <hr>
                    <button type="button" class="btn btn-info btn-sm" onclick="requestInstructorRole()">
                      강사 권한 요청
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
            
            <!-- 활동 통계 섹션 -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">활동 통계</h5>
              
              <div class="row text-center">
                <div class="col-md-3">
                  <div class="border rounded p-3">
                    <h4 class="text-primary mb-1"><%= @user.enrolled_courses.count %></h4>
                    <small class="text-muted">수강 강의</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="border rounded p-3">
                    <h4 class="text-success mb-1"><%= @user.reviews.count %></h4>
                    <small class="text-muted">작성 리뷰</small>
                  </div>
                </div>
                <% if @user.instructor? %>
                  <div class="col-md-3">
                    <div class="border rounded p-3">
                      <h4 class="text-warning mb-1"><%= @user.taught_courses.count %></h4>
                      <small class="text-muted">개설 강의</small>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="border rounded p-3">
                      <h4 class="text-info mb-1"><%= @user.taught_courses.sum(&:total_students) %></h4>
                      <small class="text-muted">총 수강생</small>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
            
            <!-- 버튼 영역 -->
            <div class="d-flex justify-content-between">
              <%= link_to "취소", @user, class: "btn btn-outline-secondary" %>
              <div>
                <%= f.submit "프로필 업데이트", class: "btn btn-primary" %>
              </div>
            </div>
            
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 폼 유효성 검사 스크립트 -->
<script>
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();

function requestInstructorRole() {
  if (confirm('강사 권한을 요청하시겠습니까? 관리자가 검토 후 승인해드립니다.')) {
    alert('강사 권한 요청이 접수되었습니다. 검토 후 연락드리겠습니다.');
  }
}
</script>