<% content_for :title, "수강 신청함 - 정화의 서재" %>

<!-- 장바구니 전용 고정 헤더 -->
<div class="cart-sticky-header">
  <div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center py-3">
      <div class="cart-header-left">
        <h1 class="fw-bold mb-1">🎓 수강 신청함</h1>
        <small class="text-muted" id="cart-item-count">신청 강의: <%= @cart_items.count %>개</small>
      </div>
      <div class="cart-header-right">
        <% if @cart_items.any? %>
          <button type="button" 
                  class="btn btn-outline-danger btn-sm"
                  onclick="clearCart()">
🗑️ 신청함 비우기
          </button>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
/* 장바구니 헤더 완전 고정 */
.cart-sticky-header {
  position: fixed !important;
  top: 76px !important;
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  background: #ffffff !important;
  border-bottom: 2px solid #dee2e6 !important;
  z-index: 1050 !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* 장바구니 콘텐츠 여백 */
.cart-content-wrapper {
  margin-top: 160px !important;
  min-height: calc(100vh - 240px) !important;
}

/* 네비게이션 바와의 겹침 방지 */
.cart-sticky-header .container-fluid {
  max-width: 100% !important;
  margin: 0 auto !important;
}

.cart-header-left {
  flex-shrink: 0;
}

.cart-header-right {
  flex-shrink: 0;
  white-space: nowrap;
}

/* 반응형 조정 */
@media (max-width: 768px) {
  .cart-sticky-header {
    top: 76px !important;
  }
  
  .cart-content-wrapper {
    margin-top: 180px !important;
  }
  
  .cart-sticky-header .d-flex {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 15px;
  }
  
  .cart-header-right {
    align-self: center !important;
  }
}

@media (max-width: 576px) {
  .cart-content-wrapper {
    margin-top: 200px !important;
  }
}

/* 강제 고정을 위한 추가 스타일 */
.cart-sticky-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #ffffff;
  z-index: -1;
}
</style>

<div class="container cart-content-wrapper">

  <% if @cart_items.any? %>
    <div class="row">
      <div class="col-lg-8">
        <!-- 수강 신청 강의들 -->
        <% @cart_items.each do |cart_item| %>
          <div class="cart-item">
            <div class="row align-items-center">
              <div class="col-md-2">
                <div class="cart-item-image">
                  <% if cart_item.course.thumbnail.present? %>
                    <%= image_tag cart_item.course.thumbnail, class: "w-100 h-100 rounded", style: "object-fit: cover;" %>
                  <% else %>
                    <div class="w-100 h-100 bg-primary d-flex align-items-center justify-content-center rounded">
                      <i class="bi bi-play-circle text-white"></i>
                    </div>
                  <% end %>
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 class="mb-2">
                  <%= link_to cart_item.course.title, cart_item.course, class: "text-decoration-none text-dark" %>
                </h6>
                <p class="text-muted mb-1">
                  <i class="bi bi-person"></i> <%= cart_item.course.instructor.name %>
                </p>
                <div class="d-flex align-items-center">
                  <div class="rating me-2">
                    <% 5.times do |i| %>
                      <i class="bi bi-star<%= i < cart_item.course.average_rating ? '-fill' : '' %> text-warning"></i>
                    <% end %>
                  </div>
                  <small class="text-muted">
                    <%= cart_item.course.average_rating %> (<%= cart_item.course.reviews.count %>)
                  </small>
                </div>
              </div>
              
              <div class="col-md-2 text-center">
                <span class="fw-bold text-primary">
                  ₩<%= number_with_delimiter(cart_item.course.price) %>
                </span>
              </div>
              
              <div class="col-md-2 text-end">
                <button type="button" 
                        class="btn btn-outline-danger btn-sm" 
                        onclick="deleteCartItem(<%= cart_item.id %>, '<%= cart_item.course.title.gsub("'", "\\\\'") %>')"
                        title="수강 신청 취소">
                  ❌
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 주문 요약 -->
      <div class="col-lg-4">
        <div class="sticky-top" style="top: 100px;">
          <div class="card border-0 shadow">
            <div class="card-body">
              <h5 class="fw-bold mb-4">📋 수강 요약</h5>
              
              <div class="d-flex justify-content-between mb-2">
                <span>🎓 강의 수량</span>
                <span><%= @cart_items.count %>개</span>
              </div>
              
              <div class="d-flex justify-content-between mb-3">
                <span>💰 총 수강료</span>
                <span class="fw-bold">₩<%= number_with_delimiter(@total_price) %></span>
              </div>
              
              <hr>
              
              <div class="d-flex justify-content-between mb-4">
                <span class="fw-bold">🏷️ 최종 금액</span>
                <span class="fw-bold text-primary h5">₩<%= number_with_delimiter(@total_price) %></span>
              </div>
              
              <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" onclick="enrollAllCourses()">
                  <i class="bi bi-mortarboard"></i> 전체 수강하기
                </button>
                <small class="text-muted text-center">
                  🎓 수강 시스템은 데모용입니다
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <!-- 빈 수강 신청함 -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <div class="empty-library-illustration mb-4">
            <i class="bi bi-mortarboard display-1 text-muted mb-3"></i>
            <div class="floating-books">
              <i class="bi bi-camera-video text-primary opacity-50"></i>
              <i class="bi bi-play-circle text-warning opacity-50"></i>
              <i class="bi bi-award text-success opacity-50"></i>
            </div>
          </div>
          <h3 class="text-muted mb-3">🎓 수강 신청함이 비어있습니다</h3>
          <p class="text-muted mb-4">관심 있는 강의를 신청함에 담아보세요</p>
          <%= link_to courses_path, class: "btn btn-primary btn-lg" do %>
            <i class="bi bi-search"></i> 강의 둘러보기
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
// 전체 수강하기 함수
function enrollAllCourses() {
  if (confirm('수강 신청함의 모든 강의를 수강하시겠습니까?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '<%= enroll_all_cart_items_path %>';
    
    const token = document.createElement('input');
    token.type = 'hidden';
    token.name = 'authenticity_token';
    token.value = '<%= form_authenticity_token %>';
    form.appendChild(token);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// 개별 강의 제거 확인 함수
function deleteCartItem(cartItemId, courseTitle) {
  showCustomConfirm(
    '❌ 수강 취소',
    '"' + courseTitle + '" 강의의 수강 신청을 취소하시겠습니까?',
    '수강 취소',
    '취소',
    function() {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/cart_items/' + cartItemId;
      
      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'DELETE';
      form.appendChild(methodInput);
      
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'authenticity_token';
      tokenInput.value = '<%= form_authenticity_token %>';
      form.appendChild(tokenInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  );
}

// 수강 신청함 비우기 확인 함수
function clearCart() {
  showCustomConfirm(
    '🗑️ 신청함 비우기',
    '수강 신청함의 모든 강의를 제거하시겠습니까?',
    '모두 제거하기',
    '취소',
    function() {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/cart_items/clear';
      
      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'DELETE';
      form.appendChild(methodInput);
      
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'authenticity_token';
      tokenInput.value = '<%= form_authenticity_token %>';
      form.appendChild(tokenInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  );
}

// 커스텀 확인 대화상자 함수
function showCustomConfirm(title, message, confirmText, cancelText, onConfirm) {
  // 기존 모달 제거
  const existingModal = document.getElementById('custom-confirm-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // 모달 생성
  const modal = document.createElement('div');
  modal.id = 'custom-confirm-modal';
  modal.className = 'custom-confirm-modal';
  modal.innerHTML = `
    <div class="custom-confirm-overlay"></div>
    <div class="custom-confirm-dialog">
      <div class="custom-confirm-header">
        <h4 class="custom-confirm-title">${title}</h4>
      </div>
      <div class="custom-confirm-body">
        <p class="custom-confirm-message">${message}</p>
      </div>
      <div class="custom-confirm-footer">
        <button class="btn btn-outline-secondary custom-confirm-cancel">${cancelText}</button>
        <button class="btn btn-danger custom-confirm-ok">${confirmText}</button>
      </div>
    </div>
  `;
  
  // body에 추가
  document.body.appendChild(modal);
  
  // 이벤트 리스너 추가
  modal.querySelector('.custom-confirm-cancel').addEventListener('click', function() {
    modal.remove();
  });
  
  modal.querySelector('.custom-confirm-ok').addEventListener('click', function() {
    modal.remove();
    if (onConfirm) onConfirm();
  });
  
  modal.querySelector('.custom-confirm-overlay').addEventListener('click', function() {
    modal.remove();
  });
  
  // ESC 키로 닫기
  const escHandler = function(e) {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
  
  // 애니메이션
  setTimeout(() => {
    modal.classList.add('show');
  }, 10);
}
</script>

<style>
/* 커스텀 확인 대화상자 스타일 */
.custom-confirm-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.custom-confirm-modal.show {
  opacity: 1;
}

.custom-confirm-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(3px);
}

.custom-confirm-dialog {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  min-width: 400px;
  max-width: 500px;
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.custom-confirm-modal.show .custom-confirm-dialog {
  transform: translate(-50%, -50%) scale(1);
}

.custom-confirm-header {
  padding: 24px 24px 16px 24px;
  border-bottom: 1px solid #e9ecef;
}

.custom-confirm-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #333;
}

.custom-confirm-body {
  padding: 20px 24px;
}

.custom-confirm-message {
  margin: 0;
  font-size: 1rem;
  line-height: 1.5;
  color: #666;
}

.custom-confirm-footer {
  padding: 16px 24px 24px 24px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.custom-confirm-footer .btn {
  min-width: 80px;
  padding: 8px 20px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.custom-confirm-ok {
  background: #dc3545 !important;
  border-color: #dc3545 !important;
}

.custom-confirm-ok:hover {
  background: #c82333 !important;
  border-color: #c82333 !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.custom-confirm-cancel:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* 빈 서재함 일러스트레이션 */
.empty-library-illustration {
  position: relative;
  display: inline-block;
}

.floating-books {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  gap: 15px;
  animation: float-books 3s ease-in-out infinite;
}

.floating-books i {
  font-size: 2rem;
  animation: float-individual 2s ease-in-out infinite;
}

.floating-books i:nth-child(1) {
  animation-delay: 0s;
}

.floating-books i:nth-child(2) {
  animation-delay: 0.5s;
}

.floating-books i:nth-child(3) {
  animation-delay: 1s;
}

@keyframes float-books {
  0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
  50% { transform: translate(-50%, -50%) rotate(2deg); }
}

@keyframes float-individual {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}
</style>
