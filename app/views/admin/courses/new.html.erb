<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ğŸ“š ì‹ ê·œ ì½˜í…ì¸  ë“±ë¡</h1>
    <%= link_to "â† ëª©ë¡", admin_courses_path, class: "btn btn-outline-secondary" %>
  </div>

  <%= form_with model: [:admin, @course], html: { multipart: true, class: 'content-upload-form' } do |f| %>
    <!-- 1ï¸âƒ£ ì½˜í…ì¸  ìœ í˜• ì„ íƒ -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0" id="content-type-heading">1ï¸âƒ£ ì½˜í…ì¸  ìœ í˜• ì„ íƒ</h5>
      </div>
      <div class="card-body">
        <div class="row g-3" role="group" aria-labelledby="content-type-heading">
          <div class="col-md-4">
            <div class="content-type-card" data-type="ebook">
              <input type="radio" name="content_type_selection" value="ebook" id="type_ebook" checked>
              <label for="type_ebook" class="content-type-label">
                <div class="icon">ğŸ“š</div>
                <h5>ì „ìë™í™”ì±…</h5>
                <p class="text-muted">ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ë¡œ êµ¬ì„±ëœ ì „ìì±…</p>
              </label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="content-type-card" data-type="video">
              <input type="radio" name="content_type_selection" value="video" id="type_video">
              <label for="type_video" class="content-type-label">
                <div class="icon">ğŸ¬</div>
                <h5>êµ¬ì—°ë™í™”</h5>
                <p class="text-muted">ë¹„ë””ì˜¤ + ìë§‰ìœ¼ë¡œ êµ¬ì„±ëœ ì˜ìƒ</p>
              </label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="content-type-card" data-type="education">
              <input type="radio" name="content_type_selection" value="education" id="type_education">
              <label for="type_education" class="content-type-label">
                <div class="icon">ğŸ“–</div>
                <h5>êµìœ¡ ìë£Œ</h5>
                <p class="text-muted">í•™ìŠµìš© êµìœ¡ ì½˜í…ì¸ </p>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2ï¸âƒ£ ê¸°ë³¸ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0" id="basic-info-heading">2ï¸âƒ£ ê¸°ë³¸ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row g-3" role="group" aria-labelledby="basic-info-heading">
          <!-- ì œëª© & ë¶€ì œëª© -->
          <div class="col-md-8">
            <%= f.label :title, 'ì œëª© *', class: 'form-label' %>
            <%= f.text_field :title, class: 'form-control', placeholder: 'ì˜ˆ: ë°±ì„¤ê³µì£¼', required: true %>
          </div>
          <div class="col-md-4">
            <%= f.label :subtitle, 'ë¶€ì œëª©', class: 'form-label' %>
            <%= f.text_field :subtitle, class: 'form-control', placeholder: 'ì˜ˆ: ì°©í•œ ë§ˆìŒì”¨' %>
          </div>

          <!-- ì‹œë¦¬ì¦ˆ ì •ë³´ -->
          <div class="col-md-8">
            <%= f.label :series_name, 'ì‹œë¦¬ì¦ˆ', class: 'form-label' %>
            <%= f.text_field :series_name, class: 'form-control', placeholder: 'ì˜ˆ: ëª…ì‘ë™í™” ì‹œë¦¬ì¦ˆ', list: 'series-list' %>
            <datalist id="series-list">
              <% Course.distinct.pluck(:series_name).compact.each do |series| %>
                <option value="<%= series %>">
              <% end %>
            </datalist>
          </div>
          <div class="col-md-4">
            <%= f.label :series_order, 'ì‹œë¦¬ì¦ˆ ìˆœì„œ', class: 'form-label' %>
            <%= f.number_field :series_order, class: 'form-control', placeholder: '1', min: 1 %>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ & ì—°ë ¹ -->
          <div class="col-md-4">
            <%= f.label :category, 'ì¹´í…Œê³ ë¦¬ *', class: 'form-label' %>
            <%= f.select :category, 
              options_for_select([
                ['ì „ë˜ë™í™”', 'ì „ë˜ë™í™”'],
                ['ëª…ì‘ë™í™”', 'ëª…ì‘ë™í™”'],
                ['ì°½ì‘ë™í™”', 'ì°½ì‘ë™í™”'],
                ['ì „ìë™í™”ì±…', 'ì „ìë™í™”ì±…'],
                ['êµ¬ì—°ë™í™”', 'êµ¬ì—°ë™í™”'],
                ['êµìœ¡ìë£Œ', 'êµìœ¡ìë£Œ']
              ]), 
              { prompt: 'ì„ íƒí•˜ì„¸ìš”' }, 
              class: 'form-select', 
              required: true 
            %>
          </div>
          <div class="col-md-4">
            <%= f.label :age, 'ì—°ë ¹ *', class: 'form-label' %>
            <%= f.select :age,
              options_for_select([
                ['ì•„ê¸° (0-2ì„¸)', 'baby'],
                ['ìœ ì•„ (3-5ì„¸)', 'toddler'],
                ['ì´ˆë“± (6-13ì„¸)', 'elementary'],
                ['ì²­ì†Œë…„ (14-16ì„¸)', 'teen']
              ]),
              { prompt: 'ì„ íƒí•˜ì„¸ìš”' },
              class: 'form-select',
              required: true
            %>
          </div>
          <div class="col-md-4">
            <%= f.label :difficulty, 'ë‚œì´ë„ (ë³„ì )', class: 'form-label' %>
            <div class="difficulty-selector">
              <% (1..5).each do |level| %>
                <input type="radio" name="course[difficulty]" value="<%= level %>" id="difficulty_<%= level %>" <%= 'checked' if level == 3 %>>
                <label for="difficulty_<%= level %>">â­</label>
              <% end %>
            </div>
            <small class="form-text text-muted">ë³„ 1ê°œ(ì‰¬ì›€) ~ 5ê°œ(ì–´ë ¤ì›€)</small>
          </div>

          <!-- ê°€ê²© & í• ì¸ -->
          <div class="col-md-4">
            <%= f.label :price, 'ê°€ê²© (ì›) *', class: 'form-label' %>
            <%= f.number_field :price, class: 'form-control', placeholder: '9900', step: '100', required: true %>
          </div>
          <div class="col-md-4">
            <%= f.label :discount_percentage, 'í• ì¸ìœ¨ (%)', class: 'form-label' %>
            <%= f.number_field :discount_percentage, class: 'form-control', placeholder: '0', min: 0, max: 100 %>
          </div>
          <div class="col-md-4">
            <%= f.label :level, 'í•™ìŠµ ë‹¨ê³„ *', class: 'form-label' %>
            <%= f.select :level,
              options_for_select([
                ['ì´ˆê¸‰', 'beginner'],
                ['ì¤‘ê¸‰', 'intermediate'],
                ['ê³ ê¸‰', 'advanced']
              ]),
              { prompt: 'ì„ íƒí•˜ì„¸ìš”' },
              class: 'form-select',
              required: true
            %>
          </div>

          <!-- ì†Œìš”ì‹œê°„ -->
          <div class="col-md-4">
            <%= f.label :duration, 'ì†Œìš”ì‹œê°„ (ë¶„) *', class: 'form-label' %>
            <%= f.number_field :duration, class: 'form-control', placeholder: '15', required: true %>
          </div>

          <!-- íƒœê·¸ -->
          <div class="col-md-8">
            <%= f.label :tags, 'íƒœê·¸', class: 'form-label' %>
            <%= f.text_field :tags, class: 'form-control', placeholder: '#ë™ë¬¼, #ìš°ì •, #êµí›ˆ' %>
            <small class="form-text text-muted">ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì„¸ìš”</small>
          </div>

          <!-- ì„¤ëª… -->
          <div class="col-12">
            <%= f.label :description, 'ì„¤ëª… *', class: 'form-label' %>
            <%= f.text_area :description, rows: 4, class: 'form-control', placeholder: 'ì½˜í…ì¸  ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...', required: true %>
          </div>
        </div>
      </div>
    </div>

    <!-- 3ï¸âƒ£ ì œì‘ì§„ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0" id="author-info-heading">3ï¸âƒ£ ì œì‘ì§„ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row g-3" role="group" aria-labelledby="author-info-heading">
          <div class="col-md-4">
            <label class="form-label">ì‘ê°€</label>
            <div class="input-group">
              <%= select_tag 'course[writer_id]', 
                options_from_collection_for_select(@authors.writers, :id, :name),
                { include_blank: 'ì„ íƒí•˜ì„¸ìš”', class: 'form-select' }
              %>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newAuthorModal" data-role="writer">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°</label>
            <div class="input-group">
              <%= select_tag 'course[illustrator_id]',
                options_from_collection_for_select(@authors.illustrators, :id, :name),
                { include_blank: 'ì„ íƒí•˜ì„¸ìš”', class: 'form-select' }
              %>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newAuthorModal" data-role="illustrator">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4 narrator-field">
            <label class="form-label">ì„±ìš° (êµ¬ì—°ë™í™”ë§Œ)</label>
            <div class="input-group">
              <%= select_tag 'course[narrator_id]',
                options_from_collection_for_select(@authors.narrators, :id, :name),
                { include_blank: 'ì„ íƒí•˜ì„¸ìš”', class: 'form-select' }
              %>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newAuthorModal" data-role="narrator">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <%= f.label :production_date, 'ì œì‘ì¼', class: 'form-label' %>
            <%= f.date_field :production_date, class: 'form-control', value: Date.today %>
          </div>
        </div>
      </div>
    </div>

    <!-- 4ï¸âƒ£ ì½˜í…ì¸  íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card mb-4">
      <div class="card-header bg-warning">
        <h5 class="mb-0" id="file-upload-heading">4ï¸âƒ£ ì½˜í…ì¸  íŒŒì¼ ì—…ë¡œë“œ</h5>
      </div>
      <div class="card-body">
        <div id="file-upload-area" class="file-upload-dropzone" role="region" aria-labelledby="file-upload-heading" aria-dropeffect="copy">
          <div class="dropzone-content">
            <i class="bi bi-cloud-upload display-1 text-muted"></i>
            <h4>ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</h4>
            <p class="text-muted">ë˜ëŠ”</p>
            <label for="file-input" class="btn btn-primary">
              ğŸ“‚ íŒŒì¼ ì„ íƒ
            </label>
            <input type="file" id="file-input" name="course[content_files][]" multiple style="display: none;" aria-label="ì½˜í…ì¸  íŒŒì¼ ì„ íƒ" accept="image/jpeg,image/png,text/plain,video/mp4">
            
            <div class="mt-3">
              <small class="text-muted">
                <span class="ebook-hint">âœ“ í˜ì´ì§€ ì´ë¯¸ì§€: page_001.jpg, page_002.jpg ...</span>
                <span class="video-hint" style="display: none;">âœ“ ë¹„ë””ì˜¤: main.mp4 ë˜ëŠ” index.m3u8</span>
              </small>
            </div>
          </div>

          <!-- íŒŒì¼ ëª©ë¡ -->
          <div id="file-list" class="file-list mt-3" style="display: none;">
            <h6>ì—…ë¡œë“œí•  íŒŒì¼:</h6>
            <div id="file-items" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 5ï¸âƒ£ ì¸ë„¤ì¼ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">5ï¸âƒ£ ì¸ë„¤ì¼</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="thumbnail_option" id="thumbnail_ai" value="ai" checked>
              <label class="form-check-label" for="thumbnail_ai">
                âœ¨ AI ìë™ ìƒì„± (ì¶”ì²œ)
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="thumbnail_option" id="thumbnail_first" value="first">
              <label class="form-check-label" for="thumbnail_first">
                ğŸ“„ ì²« í˜ì´ì§€ ì‚¬ìš© (ì „ìì±…ë§Œ)
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="thumbnail_option" id="thumbnail_upload" value="upload">
              <label class="form-check-label" for="thumbnail_upload">
                ğŸ“¤ ìˆ˜ë™ ì—…ë¡œë“œ
              </label>
            </div>
            <div id="thumbnail-upload-field" style="display: none;" class="mt-2">
              <%= f.url_field :thumbnail, class: 'form-control', placeholder: 'ì¸ë„¤ì¼ URL ì…ë ¥' %>
            </div>
          </div>
          <div class="col-md-6">
            <div id="thumbnail-preview" class="border rounded p-3 text-center">
              <p class="text-muted">ë¯¸ë¦¬ë³´ê¸°</p>
              <div id="thumbnail-preview-image"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 6ï¸âƒ£ ë°œí–‰ ì„¤ì • -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">6ï¸âƒ£ ë°œí–‰ ì„¤ì •</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <%= f.label :status, 'ìƒíƒœ', class: 'form-label' %>
            <%= f.select :status,
              options_for_select([
                ['ì¦‰ì‹œ ë°œí–‰', 'published'],
                ['ì„ì‹œ ì €ì¥', 'draft'],
                ['ë³´ê´€', 'archived']
              ], 'draft'),
              {},
              class: 'form-select'
            %>
          </div>
        </div>
      </div>
    </div>

    <!-- ì œì¶œ ë²„íŠ¼ -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
      <%= link_to "ì·¨ì†Œ", admin_courses_path, class: "btn btn-outline-secondary btn-lg" %>
      <%= f.submit "ğŸ’¾ ì €ì¥í•˜ê³  ì—…ë¡œë“œ", class: "btn btn-primary btn-lg", data: { disable_with: 'ì²˜ë¦¬ ì¤‘...' } %>
    </div>
  <% end %>
</div>

<!-- ì‘ê°€ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="newAuthorModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ì‹ ê·œ ì‘ê°€ ë“±ë¡</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">ì´ë¦„ *</label>
          <input type="text" class="form-control" id="new-author-name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">ì—­í• </label>
          <select class="form-select" id="new-author-role">
            <option value="writer">ì‘ê°€</option>
            <option value="illustrator">ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°</option>
            <option value="narrator">ì„±ìš°</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">ì†Œê°œ</label>
          <textarea class="form-control" id="new-author-bio" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" id="save-new-author">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<style>
.content-type-card {
  position: relative;
  cursor: pointer;
}

.content-type-card input[type="radio"] {
  position: absolute;
  opacity: 0;
}

.content-type-label {
  display: block;
  padding: 2rem;
  border: 2px solid #dee2e6;
  border-radius: 0.5rem;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.content-type-card input:checked + .content-type-label {
  border-color: #0d6efd;
  background-color: #e7f1ff;
}

.content-type-label .icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.difficulty-selector {
  display: flex;
  gap: 0.5rem;
}

.difficulty-selector input[type="radio"] {
  display: none;
}

.difficulty-selector label {
  font-size: 1.5rem;
  cursor: pointer;
  opacity: 0.3;
  transition: opacity 0.2s;
}

.difficulty-selector input:checked ~ label,
.difficulty-selector input:checked + label {
  opacity: 1;
}

.difficulty-selector label:hover {
  opacity: 0.7;
}

.file-upload-dropzone {
  border: 2px dashed #dee2e6;
  border-radius: 0.5rem;
  padding: 3rem;
  text-align: center;
  transition: all 0.3s;
}

.file-upload-dropzone.dragover {
  border-color: #0d6efd;
  background-color: #e7f1ff;
}

.file-list {
  text-align: left;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-item.valid {
  border-left: 3px solid #28a745;
}

.file-item.invalid {
  border-left: 3px solid #dc3545;
}

/* ===== ëª¨ë°”ì¼ ë°˜ì‘í˜• ê°œì„  ===== */
@media (max-width: 768px) {
  .content-type-card {
    margin-bottom: 1rem;
  }
  
  .content-type-label {
    padding: 1.5rem 1rem;
  }
  
  .content-type-label .icon {
    font-size: 2rem;
  }
  
  .content-type-label h5 {
    font-size: 1rem;
  }
  
  .content-type-label p {
    font-size: 0.85rem;
  }
  
  .card-header h5 {
    font-size: 1rem;
  }
  
  .file-upload-dropzone {
    padding: 1.5rem;
  }
  
  .file-upload-dropzone h4 {
    font-size: 1.2rem;
  }
  
  .difficulty-selector label {
    font-size: 1.2rem;
  }
  
  /* ì…ë ¥ í•„ë“œ í¬ê¸° ì¡°ì • */
  .form-control, .form-select {
    font-size: 16px !important; /* iOS zoom ë°©ì§€ */
  }
}

@media (max-width: 576px) {
  .content-type-card {
    width: 100%;
  }
  
  /* ì¹´ë“œ ì—¬ë°± ì¶•ì†Œ */
  .card {
    margin-bottom: 1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
  .btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }
}
</style>

<script type="module">
// íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬
let selectedFiles = [];

function initFileUpload() {
  const dropzone = document.getElementById('file-upload-area');
  const fileInput = document.getElementById('file-input');
  const fileList = document.getElementById('file-list');
  const fileItems = document.getElementById('file-items');

  if (!dropzone || !fileInput) return;

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  });

  // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    handleFiles(files);
  });

  function handleFiles(files) {
    // íŒŒì¼ëª… ìë™ ì •ê·œí™” ì˜µì…˜
    const shouldNormalize = confirm('íŒŒì¼ëª…ì„ ìë™ìœ¼ë¡œ ì •ê·œí™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì˜ˆ: "í˜ì´ì§€1.jpg" â†’ "page_001.jpg")');
    
    if (shouldNormalize) {
      files = Array.from(files).map(file => {
        const normalized = normalizeFileName(file.name);
        if (normalized !== file.name) {
          return new File([file], normalized, { type: file.type });
        }
        return file;
      });
    }
    
    selectedFiles = [...selectedFiles, ...files];
    validateAndSortFiles();
    displayFiles();
  }
  
  function normalizeFileName(filename) {
    // "í˜ì´ì§€1.jpg" â†’ "page_001.jpg"
    // "ì´ë¯¸ì§€_1.png" â†’ "page_001.png"
    const ext = filename.split('.').pop().toLowerCase();
    const match = filename.match(/(\d+)/);
    
    if (!match) return filename;
    
    const number = match[1].padStart(3, '0');
    return `page_${number}.${ext}`;
  }

  function validateAndSortFiles() {
    const contentType = getSelectedContentType();
    
    // íŒŒì¼ëª…ìœ¼ë¡œ ì •ë ¬
    selectedFiles.sort((a, b) => {
      const aMatch = a.name.match(/page_(\d+)/);
      const bMatch = b.name.match(/page_(\d+)/);
      
      if (aMatch && bMatch) {
        return parseInt(aMatch[1]) - parseInt(bMatch[1]);
      }
      return a.name.localeCompare(b.name);
    });

    // íŒŒì¼ ê²€ì¦
    selectedFiles.forEach(file => {
      file.valid = validateFile(file, contentType);
    });
  }

  function validateFile(file, contentType) {
    const validations = {
      errors: [],
      warnings: []
    };

    const ext = file.name.split('.').pop().toLowerCase();
    
    if (contentType === 'ebook') {
      const validExts = ['jpg', 'jpeg', 'png', 'txt'];
      if (!validExts.includes(ext)) {
        validations.errors.push('ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹');
      }

      if (['jpg', 'jpeg', 'png', 'txt'].includes(ext)) {
        if (!/^page_\d{3,4}\.(jpg|jpeg|png|txt)$/i.test(file.name)) {
          validations.errors.push('íŒŒì¼ëª… í˜•ì‹ ì˜¤ë¥˜ (ì˜ˆ: page_001.jpg)');
        }
      }

      const maxSize = ext === 'txt' ? 100 * 1024 : 10 * 1024 * 1024;
      if (file.size > maxSize) {
        validations.errors.push(`íŒŒì¼ í¬ê¸° ì´ˆê³¼ (ìµœëŒ€ ${formatFileSize(maxSize)})`);
      }
    } else if (contentType === 'video') {
      const validExts = ['mp4', 'webm', 'm3u8', 'vtt', 'srt'];
      if (!validExts.includes(ext)) {
        validations.errors.push('ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹');
      }

      const maxSize = 500 * 1024 * 1024;
      if (file.size > maxSize) {
        validations.errors.push(`íŒŒì¼ í¬ê¸° ì´ˆê³¼ (ìµœëŒ€ ${formatFileSize(maxSize)})`);
      }
    }

    const duplicates = selectedFiles.filter(f => f !== file && f.name === file.name);
    if (duplicates.length > 0) {
      validations.warnings.push('ì¤‘ë³µ íŒŒì¼ëª…');
    }

    return {
      isValid: validations.errors.length === 0,
      errors: validations.errors,
      warnings: validations.warnings
    };
  }

  function displayFiles() {
    if (selectedFiles.length === 0) {
      fileList.style.display = 'none';
      return;
    }

    fileList.style.display = 'block';
    fileItems.innerHTML = '';

    selectedFiles.forEach((file, index) => {
      const item = document.createElement('div');
      item.className = `list-group-item file-item ${file.valid?.isValid ? 'valid' : 'invalid'}`;
      
      const validIcon = file.valid?.isValid ? 'âœ“' : 'âš ';
      const validClass = file.valid?.isValid ? 'text-success' : 'text-danger';
      
      let errorText = '';
      if (file.valid && !file.valid.isValid) {
        errorText = `<small class="text-danger d-block">${file.valid.errors.join(', ')}</small>`;
      }
      if (file.valid && file.valid.warnings.length > 0) {
        errorText += `<small class="text-warning d-block">${file.valid.warnings.join(', ')}</small>`;
      }

      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <span class="${validClass} me-2">${validIcon}</span>
            <strong>${file.name}</strong>
            <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            ${errorText}
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="window.removeFile(${index})">
            ğŸ—‘ï¸
          </button>
        </div>
      `;
      
      fileItems.appendChild(item);
    });

    const summary = document.createElement('div');
    summary.className = 'mt-3 p-3 bg-light rounded';
    const validCount = selectedFiles.filter(f => f.valid?.isValid).length;
    const totalCount = selectedFiles.length;
    
    summary.innerHTML = `
      <strong>íŒŒì¼ ìš”ì•½:</strong>
      ì´ ${totalCount}ê°œ íŒŒì¼ |
      <span class="text-success">âœ“ ${validCount}ê°œ ìœ íš¨</span> |
      <span class="text-danger">âš  ${totalCount - validCount}ê°œ ë¬¸ì œ</span>
    `;
    
    fileItems.appendChild(summary);
  }

  function getSelectedContentType() {
    const selected = document.querySelector('input[name="content_type_selection"]:checked');
    return selected ? selected.value : 'ebook';
  }

  window.removeFile = function(index) {
    selectedFiles.splice(index, 1);
    displayFiles();
  };

  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
}

// ===== ì „ì—­ ìƒíƒœ ê´€ë¦¬ =====
let isDirty = false;
let isSubmitting = false;
let autosaveInterval = null;

document.addEventListener('DOMContentLoaded', function() {
  // ì½˜í…ì¸  íƒ€ì… ë³€ê²½ ì‹œ
  document.querySelectorAll('input[name="content_type_selection"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const isVideo = this.value === 'video';
      const narratorField = document.querySelector('.narrator-field');
      if (narratorField) narratorField.style.display = isVideo ? 'block' : 'none';
      
      const ebookHint = document.querySelector('.ebook-hint');
      if (ebookHint) ebookHint.style.display = isVideo ? 'none' : 'inline';
      
      const videoHint = document.querySelector('.video-hint');
      if (videoHint) videoHint.style.display = isVideo ? 'inline' : 'none';
      
      isDirty = true;
    });
  });

  // ì¸ë„¤ì¼ ì˜µì…˜ ë³€ê²½
  document.querySelectorAll('input[name="thumbnail_option"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const uploadField = document.getElementById('thumbnail-upload-field');
      if (uploadField) uploadField.style.display = this.value === 'upload' ? 'block' : 'none';
      isDirty = true;
    });
  });

  // ë‚œì´ë„ ë³„ í‘œì‹œ
  const difficultyInputs = document.querySelectorAll('.difficulty-selector input[type="radio"]');
  difficultyInputs.forEach(input => {
    input.addEventListener('change', function() {
      const level = parseInt(this.value);
      const labels = document.querySelectorAll('.difficulty-selector label');
      
      labels.forEach((label, index) => {
        if (index < level) {
          label.style.opacity = '1';
        } else {
          label.style.opacity = '0.3';
        }
      });
      isDirty = true;
    });
  });

  // ===== 1. ì¤‘ë³µ ì œì¶œ ë°©ì§€ =====
  const form = document.querySelector('.content-upload-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      if (isSubmitting) {
        e.preventDefault();
        showToast('ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤', 'warning');
        return false;
      }
      
      if (!validateFormBeforeSubmit()) {
        e.preventDefault();
        return false;
      }
      
      isSubmitting = true;
      isDirty = false; // ì œì¶œ ì‹œì—ëŠ” ë°ì´í„° ì†ì‹¤ ê²½ê³  ì•ˆ í•¨
      
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ì²˜ë¦¬ ì¤‘...';
      }
    });
  }

  // ===== 2. ë°ì´í„° ì†ì‹¤ ë°©ì§€ =====
  document.querySelectorAll('input, textarea, select').forEach(el => {
    el.addEventListener('change', () => {
      isDirty = true;
      saveToLocalStorage();
    });
  });

  window.addEventListener('beforeunload', (e) => {
    if (isDirty && !isSubmitting) {
      e.preventDefault();
      e.returnValue = 'ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
      return e.returnValue;
    }
  });

  // ===== 3. ì„ì‹œì €ì¥ ê¸°ëŠ¥ (localStorage) =====
  function saveToLocalStorage() {
    const formData = {
      title: document.querySelector('[name="course[title]"]')?.value,
      subtitle: document.querySelector('[name="course[subtitle]"]')?.value,
      category: document.querySelector('[name="course[category]"]')?.value,
      age: document.querySelector('[name="course[age]"]')?.value,
      price: document.querySelector('[name="course[price]"]')?.value,
      description: document.querySelector('[name="course[description]"]')?.value,
      tags: document.querySelector('[name="course[tags]"]')?.value,
      series_name: document.querySelector('[name="course[series_name]"]')?.value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('admin_course_draft', JSON.stringify(formData));
  }

  function loadFromLocalStorage() {
    const saved = localStorage.getItem('admin_course_draft');
    if (!saved) return;
    
    const confirmRestore = confirm('ì €ì¥ëœ ì„ì‹œ ì‘ì„± ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!confirmRestore) {
      localStorage.removeItem('admin_course_draft');
      return;
    }
    
    try {
      const data = JSON.parse(saved);
      
      Object.keys(data).forEach(key => {
        if (key === 'timestamp') return;
        const input = document.querySelector(`[name="course[${key}]"]`);
        if (input && data[key]) {
          input.value = data[key];
        }
      });
      
      showToast('ì„ì‹œ ì €ì¥ëœ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
    } catch (e) {
      console.error('ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ì‹œì €ì¥ í™•ì¸
  setTimeout(loadFromLocalStorage, 500);

  // ===== 4. ê°€ê²© í¬ë§·íŒ… =====
  const priceInput = document.querySelector('[name="course[price]"]');
  if (priceInput) {
    priceInput.addEventListener('blur', function() {
      const value = parseInt(this.value.replace(/,/g, ''));
      if (!isNaN(value)) {
        this.value = value;
        const formatted = value.toLocaleString('ko-KR');
        const helpText = this.nextElementSibling;
        if (!helpText || !helpText.classList.contains('price-formatted')) {
          const span = document.createElement('small');
          span.className = 'form-text text-muted price-formatted';
          span.textContent = `â†’ ${formatted}ì›`;
          this.parentElement.appendChild(span);
        } else {
          helpText.textContent = `â†’ ${formatted}ì›`;
        }
      }
    });
  }

  // ===== 5. íƒœê·¸ ì…ë ¥ ê°œì„  =====
  const tagsInput = document.querySelector('[name="course[tags]"]');
  if (tagsInput) {
    tagsInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const value = this.value.trim();
        if (value && !value.endsWith(',')) {
          this.value = value + ', ';
        }
      }
    });
    
    tagsInput.addEventListener('blur', function() {
      // ìë™ìœ¼ë¡œ # ì¶”ê°€
      const tags = this.value.split(',').map(tag => {
        tag = tag.trim();
        if (tag && !tag.startsWith('#')) {
          return '#' + tag;
        }
        return tag;
      }).filter(Boolean).join(', ');
      this.value = tags;
    });
  }

  // ===== 6. ì‘ê°€ ì„ íƒ ê¸°ì–µ =====
  function rememberLastAuthors() {
    const writerSelect = document.querySelector('[name="course[writer_id]"]');
    const illustratorSelect = document.querySelector('[name="course[illustrator_id]"]');
    const narratorSelect = document.querySelector('[name="course[narrator_id]"]');
    
    [writerSelect, illustratorSelect, narratorSelect].forEach(select => {
      if (select) {
        select.addEventListener('change', function() {
          const key = this.name.replace('course[', '').replace(']', '');
          localStorage.setItem(`last_${key}`, this.value);
        });
        
        // ì´ì „ ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸°
        const key = select.name.replace('course[', '').replace(']', '');
        const lastValue = localStorage.getItem(`last_${key}`);
        if (lastValue) {
          select.value = lastValue;
        }
      }
    });
  }
  
  rememberLastAuthors();


  // ===== 8. Toast ì•Œë¦¼ ì‹œìŠ¤í…œ =====
  window.showToast = function(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 5000);
  };

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
  }

  // ===== 9. í¼ ê²€ì¦ =====
  function validateFormBeforeSubmit() {
    const errors = [];
    
    const title = document.querySelector('[name="course[title]"]');
    if (!title?.value || title.value.length < 5) {
      errors.push('ì œëª©ì€ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    const category = document.querySelector('[name="course[category]"]');
    if (!category?.value || category.value === 'ì„ íƒí•˜ì„¸ìš”') {
      errors.push('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
    }
    
    const age = document.querySelector('[name="course[age]"]');
    if (!age?.value || age.value === 'ì„ íƒí•˜ì„¸ìš”') {
      errors.push('ì—°ë ¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    }
    
    const price = document.querySelector('[name="course[price]"]');
    if (!price?.value || parseInt(price.value) < 0) {
      errors.push('ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    const description = document.querySelector('[name="course[description]"]');
    if (!description?.value || description.value.length < 20) {
      errors.push('ì„¤ëª…ì€ 20ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    if (errors.length > 0) {
      showToast(errors.join('<br>'), 'error');
      return false;
    }
    
    return true;
  }

  // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
  initFileUpload();

  // ì‹ ê·œ ì‘ê°€ ë“±ë¡ (ëª¨ë‹¬)
  const saveAuthorBtn = document.getElementById('save-new-author');
  if (saveAuthorBtn) {
    saveAuthorBtn.addEventListener('click', async function() {
      const name = document.getElementById('new-author-name').value;
      const role = document.getElementById('new-author-role').value;
      const bio = document.getElementById('new-author-bio').value;

      if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
        return;
      }

      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        const response = await fetch('/admin/authors', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({
            author: { name, role, bio, active: true }
          })
        });

        if (response.ok) {
          const data = await response.json();
          
          // í•´ë‹¹ ì—­í• ì˜ selectì— ì¶”ê°€
          const select = document.querySelector(`select[name="course[${role}_id]"]`);
          if (select) {
            const option = new Option(data.name, data.id, true, true);
            select.add(option);
          }

          // ëª¨ë‹¬ ë‹«ê¸°
          const modalElement = document.getElementById('newAuthorModal');
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) modal.hide();

          // í¼ ì´ˆê¸°í™”
          document.getElementById('new-author-name').value = '';
          document.getElementById('new-author-bio').value = '';
          
          showToast('ì‘ê°€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          showToast('ì‘ê°€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    });
  }
});
</script>
