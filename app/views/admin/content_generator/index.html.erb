<% content_for :title, "AI ì½˜í…ì¸  ìƒì„±ê¸° - ê´€ë¦¬ì" %>

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1>ğŸ¨ AI ì½˜í…ì¸  ìƒì„±ê¸°</h1>
      <p class="text-muted mb-0">í˜ì´ì§€ë³„ ìŠ¤í† ë¦¬ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ê·¸ë¦¼ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
    </div>
    <%= link_to "â† ëŒ€ì‹œë³´ë“œ", admin_root_path, class: "btn btn-outline-secondary" %>
  </div>

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#generate-new">ğŸ“ ì‹ ê·œ ìƒì„±</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#manage-existing">ğŸ“š ê¸°ì¡´ ê´€ë¦¬</a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- ì‹ ê·œ ìƒì„± íƒ­ -->
    <div class="tab-pane fade show active" id="generate-new">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸ“– ìƒˆë¡œìš´ ë™í™”ì±… í˜ì´ì§€ ìƒì„±</h5>
        </div>
        <div class="card-body">
          <%= form_with url: generate_admin_content_generator_index_path, method: :post, id: 'ai-generate-form' do |f| %>
            <!-- 1ë‹¨ê³„: ì½”ìŠ¤ ì„ íƒ -->
            <div class="mb-4">
              <label class="form-label"><strong>1. ì½”ìŠ¤ ì„ íƒ</strong></label>
              <select name="course_id" id="course-select" class="form-select" required>
                <option value="">ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <% Course.where(category: ['ì „ìë™í™”ì±…', 'ebook', 'ë™í™”ì±…']).order(:title).each do |course| %>
                  <option value="<%= course.id %>" data-title="<%= course.title %>">
                    <%= course.title %> (ID: <%= course.id %>)
                  </option>
                <% end %>
              </select>
              <small class="form-text text-muted">ë˜ëŠ” ì‹ ê·œ ì½”ìŠ¤ë¥¼ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</small>
            </div>

            <!-- 2ë‹¨ê³„: í˜ì´ì§€ë³„ ìŠ¤í† ë¦¬ ì…ë ¥ -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0"><strong>2. í˜ì´ì§€ë³„ ìŠ¤í† ë¦¬ ì…ë ¥</strong></label>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="add-page-btn">
                    â• í˜ì´ì§€ ì¶”ê°€
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="auto-fill-btn">
                    ğŸ¤– AI ìë™ ìŠ¤í† ë¦¬ ìƒì„±
                  </button>
                </div>
              </div>
              
              <div id="pages-container">
                <!-- í˜ì´ì§€ 1 ê¸°ë³¸ -->
                <div class="card mb-2 page-item">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <strong>ğŸ“„ í˜ì´ì§€ 1</strong>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-page-btn">
                        ğŸ—‘ï¸ ì‚­ì œ
                      </button>
                    </div>
                    <textarea 
                      name="page_stories[]" 
                      class="form-control page-story" 
                      rows="3" 
                      placeholder="ì˜ˆ: ë°¤í•˜ëŠ˜ì— ë¹›ë‚˜ëŠ” ë³´ë¦„ë‹¬ ìœ„ì—ì„œ í† ë¼ê°€ ë–¡ë°©ì•„ë¥¼ ì°§ê³  ìˆìŠµë‹ˆë‹¤..."
                      required></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- 3ë‹¨ê³„: ìƒì„± ì˜µì…˜ -->
            <div class="mb-4">
              <label class="form-label"><strong>3. ìƒì„± ì˜µì…˜</strong></label>
              <div class="row">
                <div class="col-md-4">
                  <label class="form-label">ìŠ¤íƒ€ì¼</label>
                  <select name="style" class="form-select">
                    <option value="watercolor">ìˆ˜ì±„í™” (ê¸°ë³¸)</option>
                    <option value="digital">ë””ì§€í„¸ ì•„íŠ¸</option>
                    <option value="cartoon">ë§Œí™”í’</option>
                    <option value="pixar">3D í”½ì‚¬ ìŠ¤íƒ€ì¼</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">ìƒ‰ê°</label>
                  <select name="color_tone" class="form-select">
                    <option value="pastel">íŒŒìŠ¤í…” (ê¸°ë³¸)</option>
                    <option value="vibrant">ìƒë™ê°ìˆëŠ”</option>
                    <option value="soft">ë¶€ë“œëŸ¬ìš´</option>
                    <option value="warm">ë”°ëœ»í•œ</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">í•´ìƒë„</label>
                  <select name="resolution" class="form-select">
                    <option value="1024x1024">1024x1024 (ê¸°ë³¸)</option>
                    <option value="1536x1024">1536x1024 (ì™€ì´ë“œ)</option>
                    <option value="1024x1536">1024x1536 (ì„¸ë¡œ)</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸° -->
            <div id="preview-section" class="mb-4" style="display: none;">
              <div class="alert alert-info">
                <h6>ğŸ” í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h6>
                <pre id="prompt-preview" class="mb-0"></pre>
              </div>
            </div>

            <!-- ì œì¶œ -->
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-outline-secondary btn-lg" id="preview-prompts-btn">
                ğŸ‘ï¸ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°
              </button>
              <button type="submit" class="btn btn-primary btn-lg" id="generate-submit-btn">
                ğŸ¨ AI ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (<span id="page-count">1</span>í˜ì´ì§€)
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- ê¸°ì¡´ ê´€ë¦¬ íƒ­ -->
    <div class="tab-pane fade" id="manage-existing">
      <!-- ì „ì²´ ìƒíƒœ ìš”ì•½ -->
      <div class="row mb-4">
        <% 
          complete = @course_status.count { |s| s[:status] == 'complete' }
          partial = @course_status.count { |s| s[:status] == 'partial' }
          missing = @course_status.count { |s| s[:status] == 'missing' }
        %>
        <div class="col-md-4">
          <div class="card text-center border-success">
            <div class="card-body">
              <h3 class="text-success"><%= complete %></h3>
              <p class="mb-0">âœ… ì™„ì„± (10ì¥ ì´ìƒ)</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center border-warning">
            <div class="card-body">
              <h3 class="text-warning"><%= partial %></h3>
              <p class="mb-0">âš ï¸ ë¶€ë¶„ (1-9ì¥)</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center border-danger">
            <div class="card-body">
              <h3 class="text-danger"><%= missing %></h3>
              <p class="mb-0">âŒ í˜ì´ì§€ ì—†ìŒ</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ì½”ìŠ¤ë³„ ìƒíƒœ ë° ìƒì„± ë²„íŠ¼ -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“š ì „ìë™í™”ì±… ì½˜í…ì¸  ìƒíƒœ</h5>
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>ì œëª©</th>
                <th>ìƒíƒœ</th>
                <th>í˜ì´ì§€</th>
                <th>ìº¡ì…˜</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
              <% @course_status.each do |item| %>
                <% 
                  course = item[:course]
                  status = item[:status]
                  badge_class = case status
                    when 'complete' then 'success'
                    when 'partial' then 'warning'
                    else 'danger'
                  end
                  status_text = case status
                    when 'complete' then 'âœ… ì™„ì„±'
                    when 'partial' then 'âš ï¸ ë¶€ë¶„'
                    else 'âŒ ì—†ìŒ'
                  end
                %>
                <tr>
                  <td><%= course.id %></td>
                  <td>
                    <%= link_to course.title, course_path(course), target: '_blank' %>
                  </td>
                  <td>
                    <span class="badge bg-<%= badge_class %>"><%= status_text %></span>
                  </td>
                  <td><%= item[:page_count] %>ì¥</td>
                  <td><%= item[:caption_count] %>ê°œ</td>
                  <td>
                    <div class="btn-group" role="group">
                      <!-- í•­ìƒ ì¬ìƒì„± ë²„íŠ¼ í‘œì‹œ -->
                      <%= button_to "ğŸ¨ #{status == 'complete' ? 'ì¬' : ''}ìƒì„±", 
                          generate_admin_content_generator_index_path, 
                          method: :post,
                          params: { course_id: course.id, page_count: 15, regenerate: (status == 'complete') },
                          class: "btn btn-sm btn-#{status == 'complete' ? 'outline-primary' : 'primary'}",
                          data: { 
                            confirm: "#{course.title}ì˜ í˜ì´ì§€ 15ì¥ì„ AIë¡œ #{status == 'complete' ? 'ì¬' : ''}ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? #{status == 'complete' ? '(ê¸°ì¡´ íŒŒì¼ì€ ë°±ì—…ë©ë‹ˆë‹¤)' : ''}\nì•½ 3-5ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.",
                            disable_with: "ìƒì„± ì¤‘..." 
                          } %>
                      
                      <%= link_to "ğŸ“– ë¦¬ë”", read_course_path(course), target: '_blank', class: "btn btn-sm btn-outline-success" if status != 'missing' %>
                      
                      <%= link_to "ğŸ”§ ìˆ˜ì •", edit_admin_course_path(course), class: "btn btn-sm btn-outline-secondary" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš© ê°€ì´ë“œ -->
  <div class="card mt-4 bg-light">
    <div class="card-body">
      <h6>ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</h6>
      <ul class="mb-0">
        <li><strong>ì‹ ê·œ ìƒì„±</strong>: ì½”ìŠ¤ ì„ íƒ í›„ í˜ì´ì§€ë³„ ìŠ¤í† ë¦¬ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ê·¸ë¦¼ì„ ìƒì„±í•©ë‹ˆë‹¤</li>
        <li><strong>ìë™ ìŠ¤í† ë¦¬</strong>: ì½”ìŠ¤ ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ 15í˜ì´ì§€ ìŠ¤í† ë¦¬ë¥¼ AIê°€ ìë™ ìƒì„±í•©ë‹ˆë‹¤</li>
        <li><strong>ì¬ìƒì„±</strong>: ê¸°ì¡´ ì½˜í…ì¸ ë¥¼ ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ë¡œ ì¬ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê¸°ì¡´ íŒŒì¼ ë°±ì—…)</li>
        <li><strong>í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</strong>: ìƒì„±ë  ì´ë¯¸ì§€ì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        <li><strong>ì†Œìš” ì‹œê°„</strong>: í˜ì´ì§€ë‹¹ ì•½ 10-20ì´ˆ, 15í˜ì´ì§€ ê¸°ì¤€ 3-5ë¶„</li>
        <li><strong>ì €ì¥ ìœ„ì¹˜</strong>: <code>public/ebooks/{course_id}/pages/</code></li>
      </ul>
    </div>
  </div>
</div>

<style>
.page-item {
  transition: all 0.3s;
}

.page-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.remove-page-btn {
  opacity: 0.7;
}

.remove-page-btn:hover {
  opacity: 1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const pagesContainer = document.getElementById('pages-container');
  const addPageBtn = document.getElementById('add-page-btn');
  const autoFillBtn = document.getElementById('auto-fill-btn');
  const previewBtn = document.getElementById('preview-prompts-btn');
  const pageCountSpan = document.getElementById('page-count');
  let pageNumber = 1;

  // í˜ì´ì§€ ì¶”ê°€
  addPageBtn.addEventListener('click', function() {
    pageNumber++;
    const pageHtml = `
      <div class="card mb-2 page-item">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>ğŸ“„ í˜ì´ì§€ ${pageNumber}</strong>
            <button type="button" class="btn btn-sm btn-outline-danger remove-page-btn">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>
          <textarea 
            name="page_stories[]" 
            class="form-control page-story" 
            rows="3" 
            placeholder="ì´ í˜ì´ì§€ì˜ ìŠ¤í† ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            required></textarea>
        </div>
      </div>
    `;
    pagesContainer.insertAdjacentHTML('beforeend', pageHtml);
    updatePageCount();
    attachRemoveHandlers();
  });

  // AI ìë™ ìŠ¤í† ë¦¬ ìƒì„±
  autoFillBtn.addEventListener('click', async function() {
    const courseId = document.getElementById('course-select').value;
    if (!courseId) {
      alert('ë¨¼ì € ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      return;
    }

    const courseTitle = document.getElementById('course-select').selectedOptions[0].dataset.title;
    const pageCount = parseInt(prompt('ëª‡ í˜ì´ì§€ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', '15'));
    
    if (!pageCount || pageCount < 1 || pageCount > 30) {
      alert('1-30 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }

    // ê¸°ì¡´ í˜ì´ì§€ ì œê±°
    pagesContainer.innerHTML = '';
    pageNumber = 0;

    // AI ìŠ¤í† ë¦¬ ìƒì„± (ê°„ë‹¨í•œ í…œí”Œë¦¿)
    const storyTemplate = generateStoryTemplate(courseTitle, pageCount);
    
    storyTemplate.forEach((story, index) => {
      pageNumber = index + 1;
      const pageHtml = `
        <div class="card mb-2 page-item">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>ğŸ“„ í˜ì´ì§€ ${pageNumber}</strong>
              <button type="button" class="btn btn-sm btn-outline-danger remove-page-btn">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
            <textarea 
              name="page_stories[]" 
              class="form-control page-story" 
              rows="3" 
              required>${story}</textarea>
          </div>
        </div>
      `;
      pagesContainer.insertAdjacentHTML('beforeend', pageHtml);
    });

    updatePageCount();
    attachRemoveHandlers();
  });

  // ìŠ¤í† ë¦¬ í…œí”Œë¦¿ ìƒì„±
  function generateStoryTemplate(title, pageCount) {
    const stories = [];
    const cleanTitle = title.replace(/[ğŸ¦ğŸ§šâ€â™€ï¸ğŸ°ğŸ»ğŸ¦ŠğŸ§ğŸ¦‹ğŸ¢ğŸ¦‰ğŸ¿ï¸ğŸ­ğŸ°ğŸºğŸ·ğŸŒ¹ğŸ¸ğŸ‘¸ğŸƒğŸğŸ¦¢]/g, '').trim();
    
    for (let i = 1; i <= pageCount; i++) {
      if (i === 1) {
        stories.push(`${cleanTitle} ì´ì•¼ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ì£¼ì¸ê³µì„ ë§Œë‚˜ë³´ì„¸ìš”!`);
      } else if (i <= pageCount * 0.3) {
        stories.push(`ì£¼ì¸ê³µì´ ëª¨í—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì„ ë§Œë‚˜ìš”.`);
      } else if (i <= pageCount * 0.7) {
        stories.push(`í¥ë¯¸ì§„ì§„í•œ ì‚¬ê±´ì´ ë²Œì–´ì§‘ë‹ˆë‹¤. ì£¼ì¸ê³µì´ ë¬¸ì œë¥¼ í•´ê²°í•´ìš”.`);
      } else if (i < pageCount) {
        stories.push(`í´ë¼ì´ë§¥ìŠ¤! ê°€ì¥ ì¤‘ìš”í•œ ìˆœê°„ì´ ì°¾ì•„ì™”ì–´ìš”.`);
      } else {
        stories.push(`í•´í”¼ì—”ë”©! ëª¨ë‘ê°€ í–‰ë³µí•˜ê²Œ ëì„ ë§ºìŠµë‹ˆë‹¤.`);
      }
    }
    
    return stories;
  }

  // í˜ì´ì§€ ì‚­ì œ
  function attachRemoveHandlers() {
    document.querySelectorAll('.remove-page-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (document.querySelectorAll('.page-item').length <= 1) {
          alert('ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤');
          return;
        }
        this.closest('.page-item').remove();
        renumberPages();
        updatePageCount();
      });
    });
  }

  // í˜ì´ì§€ ë²ˆí˜¸ ì¬ì •ë ¬
  function renumberPages() {
    document.querySelectorAll('.page-item').forEach((item, index) => {
      const pageNum = index + 1;
      item.querySelector('strong').textContent = `ğŸ“„ í˜ì´ì§€ ${pageNum}`;
    });
    pageNumber = document.querySelectorAll('.page-item').length;
  }

  // í˜ì´ì§€ ìˆ˜ ì—…ë°ì´íŠ¸
  function updatePageCount() {
    const count = document.querySelectorAll('.page-item').length;
    pageCountSpan.textContent = count;
  }

  // í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°
  previewBtn.addEventListener('click', async function() {
    const courseId = document.getElementById('course-select').value;
    if (!courseId) {
      alert('ë¨¼ì € ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      return;
    }

    const stories = Array.from(document.querySelectorAll('.page-story')).map(t => t.value);
    if (stories.some(s => !s.trim())) {
      alert('ëª¨ë“  í˜ì´ì§€ì˜ ìŠ¤í† ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }

    const style = document.querySelector('[name="style"]').value;
    const colorTone = document.querySelector('[name="color_tone"]').value;
    
    let preview = `ì½”ìŠ¤ ID: ${courseId}\n`;
    preview += `ìŠ¤íƒ€ì¼: ${style}, ìƒ‰ê°: ${colorTone}\n\n`;
    
    stories.forEach((story, index) => {
      preview += `í˜ì´ì§€ ${index + 1}:\n`;
      preview += `ìŠ¤í† ë¦¬: ${story}\n`;
      preview += `í”„ë¡¬í”„íŠ¸: ${story}, ${style} style, ${colorTone} color tone, children's fairy tale illustration, warm soft lighting\n\n`;
    });

    document.getElementById('prompt-preview').textContent = preview;
    document.getElementById('preview-section').style.display = 'block';
  });

  // ì´ˆê¸°í™”
  attachRemoveHandlers();
  updatePageCount();

  // í¼ ì œì¶œ ê²€ì¦
  document.getElementById('ai-generate-form').addEventListener('submit', function(e) {
    const courseId = document.getElementById('course-select').value;
    if (!courseId) {
      e.preventDefault();
      alert('ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”');
      return;
    }

    const stories = Array.from(document.querySelectorAll('.page-story')).map(t => t.value);
    if (stories.some(s => !s.trim())) {
      e.preventDefault();
      alert('ëª¨ë“  í˜ì´ì§€ì˜ ìŠ¤í† ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }

    if (!confirm(`${stories.length}í˜ì´ì§€ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜ˆìƒ ì†Œìš” ì‹œê°„: ${Math.ceil(stories.length * 15 / 60)}ë¶„`)) {
      e.preventDefault();
    }
  });
});
</script>
