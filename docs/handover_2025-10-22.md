# 2025-10-22 인수인계 (화요일)

## 개요
- Rails 서버: `http://localhost:3000` (별도 터미널에서 기동, 재시작 금지)
- 워크스페이스: `kicda-jh`
- 작업 예정일: 2025년 10월 22일 (화)
- **오늘의 목표:** 토스페이먼츠 라이브 전환 + 실결제 테스트 ⚡

---

## 📋 어제(10/21) 완료된 작업 요약

### ✅ Phase 2-1 완료
1. **환불 로직 구현** - 토스페이먼츠 API 연동
2. **주문 내역 페이지** - 목록, 상세, 필터링
3. **이용약관 & 개인정보처리방침** - 법적 요구사항 충족
4. **결제 약관 동의** - 3개 필수 항목 체크

### 🎯 현재 상태
- ✅ 결제 시스템: 테스트 모드 완료
- ✅ 환불 시스템: 로직 완성
- ✅ 법적 준비: 약관/개인정보 완료
- ⚠️ 실결제: 아직 불가 (라이브 키 필요)

---

## 🎯 오늘의 작업 목표 (10/22)

### 우선순위 1: 토스페이먼츠 라이브 전환 ⭐⭐⭐⭐⭐
**예상 소요:** 2-3시간

### 우선순위 2: 실결제 테스트 ⭐⭐⭐⭐
**예상 소요:** 1시간

### 우선순위 3: SEO 메타태그 최적화 시작 ⭐⭐⭐
**예상 소요:** 2시간

---

## 📝 상세 작업 계획

### 1️⃣ 토스페이먼츠 라이브 키 발급 (2-3시간)

#### Step 1: 가맹점 신청 준비 (30분)
**필요한 서류:**
```
✓ 사업자등록증 (정화의서재, 869-30-01778)
✓ 통신판매업 신고증 (2025-인천부평-2012호)
✓ 대표자 신분증 (권정화)
✓ 통장 사본 (정산 계좌)
```

**확인 사항:**
- [ ] 서류 스캔본 준비 (PDF)
- [ ] 정산 계좌 정보 확인
- [ ] 담당자 연락처 준비

#### Step 2: 토스페이먼츠 가맹점 신청 (1시간)
**신청 절차:**
```
1. 토스페이먼츠 홈페이지 접속
   https://www.tosspayments.com

2. "가맹점 신청" 클릭

3. 사업자 정보 입력
   - 상호: 정화의서재
   - 사업자등록번호: 869-30-01778
   - 대표자: 권정화
   - 업종: 온라인 교육 서비스
   - 주소: 인천광역시 부평구 마장로 264번길 33

4. 서비스 정보 입력
   - 서비스명: 정화의 서재
   - 웹사이트: (도메인 입력)
   - 판매 상품: 온라인 교육 콘텐츠 (전자동화책, 구연동화)
   - 예상 월 거래액: 100만원

5. 정산 계좌 입력
   - 은행명:
   - 계좌번호:
   - 예금주: 권정화

6. 서류 업로드
   - 사업자등록증
   - 통신판매업 신고증
   - 신분증
   - 통장 사본

7. 신청 제출
```

#### Step 3: 심사 대기 (1-3일)
**심사 기간:**
- 일반적으로 1-3 영업일 소요
- 빠르면 당일, 늦으면 3일

**심사 중 확인 사항:**
- [ ] 토스페이먼츠 담당자 연락 대기
- [ ] 추가 서류 요청 시 즉시 제출
- [ ] 이메일 정기 확인

#### Step 4: 라이브 키 발급 (즉시)
**승인 후 작업:**
```
1. 토스페이먼츠 대시보드 로그인

2. "개발자센터" → "API 키" 메뉴

3. 라이브 키 확인
   - Client Key (공개키)
   - Secret Key (비밀키)

4. 환경변수 설정
```

**환경변수 파일 수정:**
```bash
# .env 파일 생성/수정
cd /Users/l2dogyu/KICDA/ruby/kicda-jh

# .env 파일에 추가
TOSS_CLIENT_KEY=live_ck_XXXXXXXXXX
TOSS_SECRET_KEY=live_sk_XXXXXXXXXX
```

**Rails 환경변수 로드 확인:**
```ruby
# config/application.rb에 추가 (없다면)
# Dotenv.load('.env.local', '.env')

# 또는 직접 환경변수 설정
# export TOSS_CLIENT_KEY=live_ck_XXXXXXXXXX
# export TOSS_SECRET_KEY=live_sk_XXXXXXXXXX
```

---

### 2️⃣ 실결제 테스트 (1시간)

#### Test 1: 소액 결제 테스트 (₩1,000)

**테스트 계획:**
```
1. 테스트용 강의 생성
   - 제목: "🧪 결제 테스트 강의"
   - 가격: ₩1,000
   - 상태: published

2. 일반 사용자로 로그인
   Email: parent1@jeonghwa.com

3. 결제 프로세스 진행
   ✓ 강의 상세 페이지 접근
   ✓ "지금 구매하기" 클릭
   ✓ 약관 동의 (3개 항목 체크)
   ✓ 결제 버튼 클릭
   ✓ 토스페이먼츠 결제창
   ✓ 실제 카드 결제 (₩1,000)

4. 결제 완료 확인
   ✓ 결제 성공 메시지
   ✓ 강의 페이지로 리다이렉트
   ✓ 수강 등록 자동 완료
   ✓ 강의 시청 가능

5. 주문 내역 확인
   ✓ 대시보드 → 주문 내역
   ✓ 결제 완료 상태 표시
   ✓ 주문 상세 정보 확인
```

**체크리스트:**
```ruby
# Rails 콘솔에서 확인
cd /Users/l2dogyu/KICDA/ruby/kicda-jh
bin/rails console

# 주문 확인
order = Order.last
order.status          # => "completed"
order.payment_key     # => "실제 payment_key"
order.approved_at     # => 승인 시간

# 수강 등록 확인
user = User.find_by(email: 'parent1@jeonghwa.com')
enrollment = user.enrollments.last
enrollment.course     # => 테스트 강의
enrollment.created_at # => 주문 승인 직후

# 강의 접근 권한 확인
user.enrolled_courses.include?(enrollment.course)  # => true
```

#### Test 2: 환불 테스트 (₩1,000)

**환불 테스트 계획:**
```
1. 주문 내역 페이지 접근
   http://localhost:3000/users/2/orders

2. 방금 결제한 주문 선택
   "상세보기" 클릭

3. 환불 신청
   ✓ "환불 가능" 표시 확인 (7일 이내)
   ✓ 환불 사유 입력: "테스트 환불"
   ✓ "환불 신청" 버튼 클릭
   ✓ 확인 다이얼로그 "예" 클릭

4. 환불 처리 확인
   ✓ "환불이 완료되었습니다" 메시지
   ✓ 주문 목록으로 리다이렉트
   ✓ 주문 상태: "환불 완료"

5. 수강 등록 취소 확인
   ✓ 강의 접근 불가
   ✓ 대시보드 "수강 중인 강의" 목록에서 제거

6. 실제 환불 확인
   ✓ 토스페이먼츠 대시보드
   ✓ 환불 요청 내역 확인
   ✓ 카드사 환불 처리 (3-5일 소요)
```

**환불 확인 (Rails 콘솔):**
```ruby
# 환불된 주문 확인
order = Order.last
order.status          # => "refunded"
order.refunded_at     # => 환불 시간
order.refund_reason   # => "테스트 환불"

# 수강 등록 취소 확인
user = User.find_by(email: 'parent1@jeonghwa.com')
user.enrolled_courses.include?(order.course)  # => false
```

#### Test 3: 에러 케이스 테스트

**테스트할 에러 케이스:**
```
1. 약관 미동의 시
   ✓ 결제 버튼 비활성화
   ✓ 클릭 불가

2. 중복 결제 시도
   ✓ "이미 수강 중인 강의입니다" 메시지
   ✓ 결제 페이지 접근 차단

3. 7일 경과 후 환불 시도
   ✓ "환불 가능 기간이 지났습니다" 메시지
   ✓ 환불 신청 폼 숨김

4. 타인의 주문 접근 시도
   ✓ "권한이 없습니다" 메시지
   ✓ 메인 페이지로 리다이렉트
```

---

### 3️⃣ SEO 메타태그 최적화 시작 (2시간)

#### A. ApplicationHelper 메타태그 헬퍼 추가 (30분)

**파일:** `app/helpers/application_helper.rb`

```ruby
module ApplicationHelper
  # 기존 메소드들...

  # 메타태그 헬퍼
  def meta_title(title = nil)
    base_title = "정화의 서재"
    title.present? ? "#{title} - #{base_title}" : base_title
  end

  def meta_description(description = nil)
    description.presence || "아이들의 상상력을 키우는 특별한 동화책 플랫폼. 전자동화책, 구연동화, 동화 만들기 교육을 만나보세요."
  end

  def meta_keywords(keywords = [])
    base_keywords = %w[동화책 전자동화책 구연동화 어린이책 그림책 동화만들기 교육콘텐츠]
    (base_keywords + keywords).uniq.join(', ')
  end

  def meta_image(image_url = nil)
    image_url.presence || asset_url('default-og-image.jpg')
  end

  # Open Graph 메타태그
  def og_meta_tags(options = {})
    {
      'og:site_name' => '정화의 서재',
      'og:type' => options[:type] || 'website',
      'og:title' => meta_title(options[:title]),
      'og:description' => meta_description(options[:description]),
      'og:image' => meta_image(options[:image]),
      'og:url' => request.original_url,
      'twitter:card' => 'summary_large_image',
      'twitter:title' => meta_title(options[:title]),
      'twitter:description' => meta_description(options[:description]),
      'twitter:image' => meta_image(options[:image])
    }
  end
end
```

#### B. 레이아웃 메타태그 추가 (30분)

**파일:** `app/views/layouts/application.html.erb`

```erb
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <!-- 기본 메타태그 -->
  <title><%= content_for(:title) || meta_title %></title>
  <meta name="description" content="<%= content_for(:description) || meta_description %>">
  <meta name="keywords" content="<%= content_for(:keywords) || meta_keywords %>">
  
  <!-- Open Graph (Facebook, Kakao) -->
  <% og_tags = og_meta_tags(
    title: content_for(:title),
    description: content_for(:description),
    image: content_for(:og_image)
  ) %>
  <% og_tags.each do |property, content| %>
    <meta property="<%= property %>" content="<%= content %>">
  <% end %>
  
  <!-- 나머지 헤드 태그... -->
</head>
```

#### C. 홈페이지 메타태그 설정 (30분)

**파일:** `app/views/home/index.html.erb`

```erb
<% content_for :title, "홈" %>
<% content_for :description, "정화의 서재에서 아이들의 상상력을 키우는 전자동화책, 구연동화, 동화 만들기 교육을 만나보세요. 0-16세 아이들을 위한 특별한 콘텐츠를 제공합니다." %>
<% content_for :keywords, meta_keywords(['유아교육', '초등교육', '청소년교육', '온라인학습']) %>

<!-- 기존 홈페이지 내용... -->
```

#### D. 강의 상세 페이지 메타태그 (30분)

**파일:** `app/views/courses/show.html.erb`

```erb
<% content_for :title, @course.title %>
<% content_for :description, truncate(@course.description, length: 160) %>
<% content_for :keywords, meta_keywords([@course.category, @course.age_group]) %>
<% content_for :og_image, @course.thumbnail.present? ? @course.thumbnail.url : nil %>

<!-- 기존 강의 상세 내용... -->
```

---

## 🧪 테스트 체크리스트

### 결제 시스템 테스트
- [ ] 라이브 키 설정 확인
- [ ] ₩1,000 테스트 결제 성공
- [ ] 주문 생성 확인
- [ ] 수강 등록 자동 완료
- [ ] 환불 신청 성공
- [ ] 수강 등록 자동 취소
- [ ] 토스페이먼츠 대시보드 확인

### SEO 테스트
- [ ] 홈페이지 메타태그 확인 (소스보기)
- [ ] 강의 상세 메타태그 확인
- [ ] Open Graph 태그 확인
- [ ] 카카오톡 공유 미리보기 테스트
- [ ] Facebook 공유 미리보기 테스트

---

## 📊 예상 일정

### 오전 (09:00 - 12:00)
- **09:00-09:30** 서류 준비 및 확인
- **09:30-10:30** 토스페이먼츠 가맹점 신청
- **10:30-11:00** SEO 헬퍼 메소드 작성
- **11:00-12:00** 레이아웃 메타태그 추가

### 오후 (13:00 - 18:00)
- **13:00-14:00** 홈페이지 메타태그 설정
- **14:00-15:00** 강의 상세 메타태그 설정
- **15:00-16:00** 라이브 키 발급 대기 및 설정
- **16:00-17:00** 실결제 테스트 (₩1,000)
- **17:00-18:00** 환불 테스트 및 문서화

---

## 💰 예상 비용

### 테스트 비용
- 테스트 결제: ₩1,000
- 환불 처리: ₩1,000 (환불 예정)
- **실제 비용:** ₩0 (환불 완료 시)

### PG 수수료 (향후)
- 토스페이먼츠 수수료: 3.3%
- 예: ₩10,000 결제 시 ₩330 수수료

---

## 🔧 필요한 도구/정보

### 1. 토스페이먼츠 신청
```
✓ 토스페이먼츠 계정
✓ 사업자등록증 PDF
✓ 통신판매업 신고증 PDF
✓ 신분증 PDF
✓ 통장 사본 PDF
✓ 정산 계좌 정보
```

### 2. 테스트 카드
```
# 테스트 카드 (라이브 전에는 사용 불가)
실제 본인 카드 사용

# 소액 테스트 권장
₩1,000 - ₩5,000
```

### 3. 확인 계정
```
# 일반 사용자
Email: parent1@jeonghwa.com
Password: password123

# 관리자
Email: admin@jeonghwa.com
Password: password123
```

---

## ⚠️ 주의사항

### 1. 라이브 키 보안
- ⚠️ **절대 GitHub에 커밋 금지**
- ⚠️ `.env` 파일은 `.gitignore`에 포함
- ⚠️ Secret Key는 서버 환경변수로만 관리

**.gitignore 확인:**
```bash
cd /Users/l2dogyu/KICDA/ruby/kicda-jh
cat .gitignore | grep -i env

# 없다면 추가
echo ".env" >> .gitignore
echo ".env.local" >> .gitignore
```

### 2. 테스트 주문 관리
- ✅ 테스트 주문은 완료 후 환불 처리
- ✅ 테스트 강의는 `published: false`로 숨김
- ⚠️ 실제 고객 주문과 혼동 방지

### 3. 환불 처리 시간
- ⚠️ 카드사 환불: 영업일 기준 3-5일
- ⚠️ 즉시 환불 아님
- ⚠️ 토스페이먼츠에서는 즉시 처리, 카드사에서 시간 소요

### 4. 가맹점 심사
- ⚠️ 심사 거부 가능성 대비
- ⚠️ 추가 서류 요청 시 빠르게 대응
- ⚠️ 담당자 연락 즉시 확인

---

## 📈 성공 기준

### 오늘 작업 완료 기준
1. ✅ 토스페이먼츠 가맹점 신청 완료 (심사 중)
2. ✅ 라이브 키 발급 및 설정 (심사 통과 시)
3. ✅ 실결제 테스트 성공 (₩1,000)
4. ✅ 환불 테스트 성공
5. ✅ SEO 메타태그 기본 구조 완성

### 최소 목표
- 심사가 늦어지더라도 SEO 작업은 완료
- 테스트는 라이브 키 발급 후 진행

---

## 🔗 관련 문서

### 토스페이먼츠 문서
- [가맹점 신청 가이드](https://docs.tosspayments.com/guides/merchant)
- [API 연동 가이드](https://docs.tosspayments.com/guides/payment)
- [환불 API](https://docs.tosspayments.com/guides/cancel)

### 프로젝트 문서
- `docs/handover_2025-10-21.md` - 어제 작업 내용
- `app/controllers/payments_controller.rb` - 결제/환불 로직
- `app/views/payments/checkout.html.erb` - 결제 페이지

---

## 📞 비상 연락처

### 토스페이먼츠
- 고객센터: 1544-7772
- 이메일: support@tosspayments.com
- 운영시간: 평일 09:00 - 18:00

### 확인 사항
- [ ] 심사 진행 상황 이메일 체크
- [ ] 담당자 연락 시 즉시 응대
- [ ] 추가 서류 요청 시 당일 제출

---

## 💡 다음 작업 예고 (10/23)

### 수요일 계획
1. **사이트맵 생성**
   - sitemap_generator gem 설치
   - 전체 페이지 사이트맵 생성
   - robots.txt 설정

2. **이미지 최적화**
   - ImageMagick 설치
   - 썸네일 자동 압축
   - 평균 용량: 2.8MB → 1MB 이하

3. **구글 서치 콘솔 등록**
   - 소유권 확인
   - 사이트맵 제출
   - 색인 생성 요청

---

## 🎊 기대 효과

### 라이브 전환 시
- 💰 **실제 수익 발생 시작**
- 📊 **투명한 거래 관리**
- 🔐 **법적 안정성 확보**

### SEO 개선 시
- 🔍 **검색 노출 향상**
- 📈 **자연 유입 증가**
- 🎯 **타겟 고객 유입**

---

**작성일:** 2025년 10월 21일 18:30  
**작업 예정일:** 2025년 10월 22일 (화)  
**우선순위 1:** 토스페이먼츠 라이브 키 발급 🔑  
**우선순위 2:** 실결제 테스트 성공 💳  
**최종 목표:** 수익화 시작! 💰

---

## 🏁 빠른 시작 가이드

### 아침 첫 작업
```bash
# 1. 서버 실행 확인
curl http://localhost:3000

# 2. 서류 PDF 확인
open ~/Documents/사업자등록증.pdf

# 3. 토스페이먼츠 로그인
open https://www.tosspayments.com

# 4. 가맹점 신청 시작!
```

### 신청 완료 후
```bash
# 1. 라이브 키 환경변수 설정
cd /Users/l2dogyu/KICDA/ruby/kicda-jh
echo "TOSS_CLIENT_KEY=live_ck_XXXXX" >> .env
echo "TOSS_SECRET_KEY=live_sk_XXXXX" >> .env

# 2. 서버 재시작 (환경변수 로드)
# (별도 터미널에서 Ctrl+C 후 재시작)

# 3. 테스트 결제 진행
open http://localhost:3000
```

화이팅! 🚀

