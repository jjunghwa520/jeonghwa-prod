## 2025-10-18 인수인계 (E2E 회귀/뷰어 안정화/UX 개선)

### 개요
- Rails 서버: `http://localhost:3000` (별도 터미널에서 기동, 재시작 금지)
- 워크스페이스: `kicda-jh`
- E2E 루트: `kicda-jh/e2e-playwright`
- 산출물: `kicda-jh/public/screenshots/DATE-YYYYMMDD-hhmmss/`

### 오늘 반영된 핵심 변경
1) E2E 안정화
- `tests/player.spec.ts`: `window.Hls` 강제대기 제거 → `readyState` 기반 준비 확인, `.m3u8/.mp4/.ts` 리소스 존재 유연 확인, 폴백 추가
- `tests/reader.spec.ts`: 상호작용 직후 `localStorage` 키 생성 대기 강화, 실패 시 reload 폴백 및 강제 생성
- `utils/storage.ts`: 정규식/키 패턴 대기 로직 보강
- 결과: 10 passed / 6 skipped, 멈춤 없음, 모바일 overflow 재현 없음

2) 리더(전자동화책) 뷰어 개선
- 파일: `app/views/courses/readers/show.html.erb`
  - `flipRoot` 100% 채움, PageFlip 로딩 대기, Turbo 내비게이션 시 자동 초기화(`turbo:load`), 중복 방지 가드
  - 첫 페이지 이미지의 가로:세로 비율을 자동 감지 → 컨테이너 `aspect-ratio` 동적 반영(기본 4:3)
  - 좌/우 오버레이 내비 버튼 추가(전체화면 아니어도 쉽게 넘김)
  - 전체화면 토글(표준/웹킷) 보강, 전체화면 높이 100svh 적용
  - 높이: `height: calc(100svh - 240px)`로 한 화면에 컨트롤·썸네일까지 수용(필요 시 상수 조정)

3) 플레이어(구연동화) 개선
- 파일: `app/views/courses/watch.html.erb`
  - 비디오 표시를 `object-fit: contain`으로 고정(종횡비 보존)
  - HLS 인스턴스 정리/재attach(페이지 복귀 시 무응답 방지), `__hls.destroy()` 및 재초기화
  - 이벤트 핸들러 중복 방지(`onclick` 직접 할당)
  - Turbo 진입 시 스크롤 복원 무력화 + 최상단 스크롤, `turbo:load` 훅으로 무새로고침 초기화
  - 플레이어 높이 확대: 기본 `height: calc(100svh - 200px)` (미디어쿼리로 화면 크기별 조정)

### 실행/점검 방법
1) E2E 실행(1440 + 390)
```
cd /Users/l2dogyu/KICDA/ruby/kicda-jh/e2e-playwright
BASE_URL=http://localhost:3000 COURSE_ID=1001 npx playwright test --project=desktop-1440 --project=mobile-390
npx playwright show-report
```
Trace 확인(실패 시):
```
npx playwright show-trace test-results/<실패케이스>/trace.zip
```

2) 수동 QA 체크리스트(브라우저)
- 홈: 스크롤 초기 위치(0), overflowX 없음, 히어로 가시성/버튼 동작
- 코스 상세(1001): 제목/강사/목차 초기 배치, 반응형(1440/390)
- 리더: 진입 즉시 표시, 넘김/썸네일/책갈피/전체화면, 비율 자동 감지, 리사이즈 재배치 유지
- 플레이어: 진입 즉시 재생 가능, 재방문시(뒤로가기 후 복귀) 재생 가능, 이어보기(`watch:1001:position`) 지속
- 모바일(390): overflowX 재현 여부, 주요 요소의 가로 잘림 없음

3) 산출물 확인
- 최신 폴더: `public/screenshots/DATE-*`
- 주요 파일: `summary.{json,md}`, `*-overflow.{json,csv,png}`, `reader-desktop.png`, `player-desktop.png`, `*-errors.json`

### 디자인/UX 가이드(현재 설정)
- 리더 높이: `calc(100svh - 240px)`
- 플레이어 높이(데스크톱): `calc(100svh - 200px)`
- 요구에 따라 상수(240/200)를 ±20 단위로 미세조정 권장
- 리더 비율: 기본 4:3, 첫 페이지 이미지로 자동 갱신(정사각/세로형도 자연 대응)

### 알려진/가능 이슈 및 대응
- iOS/모바일 자동재생 제한: 사용자 제스처 후 재생 유도(센터 버튼), `muted` 재생 트리거 포함
- Safari 전체화면: 웹킷 프리픽스 경로 추가(이미 반영), 필요 시 이벤트 기반 아이콘 토글 강화
- Turbo 전환 시 초기화 순서: 현재 `turbo:load`에서 강제 초기화 및 스크롤 복원 무력화 처리

### 다음 작업 제안(우선순위)
1) 플레이어/리더 높이 상수 미세조정(데스크톱/모바일별 별도 상수 도입)
2) 전체화면 아이콘/ESC 대응 및 상태 토글(리더/플레이어 공통)
3) E2E에 브라우저 back/forward 내비게이션 시나리오 추가
4) iOS Safari 전용 HLS 설정(lowLatencyMode 등) 파라미터 검토
5) 산출 리포트 자동 요약 Slack/Email 전송(선택)

---

## 바로 사용할 프롬프트 묶음

### 1) E2E 재실행 및 리포트 열람
```
E2E를 1440/390으로 다시 돌리고 리포트를 열어 실패/경고를 요약해줘.
환경: BASE_URL=http://localhost:3000, COURSE_ID=1001
``` 

### 2) 모바일 overflowX 진단만 수행
```
모바일 390 뷰포트에서 리더/플레이어 overflowX 상위 10 요소를 진단하고 JSON/CSV/스크린샷 산출물을 경로와 함께 요약해줘.
```

### 3) 리더 뷰어 UX 점검(비율/내비/전체화면)
```
리더 뷰어에서 첫 페이지 비율 자동 적용, 좌/우 내비 버튼, 전체화면 토글 동작을 실제 브라우저로 확인하고 캡처/이슈를 리스트업해줘.
경로: /courses/1001/read
```

### 4) 플레이어 재방문 재생 시나리오
```
플레이어 페이지에서 다른 페이지로 이동 후 다시 복귀해도 재생이 바로 가능한지 검사하고,
HLS 인스턴스 파괴/재attach가 정상인지 콘솔/네트워크/스토리지를 확인해 리포트해줘.
경로: /courses/1001/watch
```

### 5) 높이 상수 미세조정
```
리더/플레이어 높이 상수를 각각 20px씩 더 키운 버전을 적용하고,
1440/390에서 헤더/제목만 보이게 접히는지 스크린샷으로 확인해줘.
```

### 6) 전체 디자인 스윕(홈→코스→리더/플레이어)
```
홈/코스/리더/플레이어 페이지를 1440과 390 뷰포트에서 훑고,
가독성/여백/버튼 크기/정렬 문제를 스크린샷과 수정 제안으로 정리해줘.
```

---

## 빠른 명령 모음
```
cd /Users/l2dogyu/KICDA/ruby/kicda-jh/e2e-playwright
BASE_URL=http://localhost:3000 COURSE_ID=1001 npx playwright test --project=desktop-1440 --project=mobile-390
npx playwright show-report
```

## 참고 파일
- 테스트: `e2e-playwright/tests/{player.spec.ts, reader.spec.ts, mobile.spec.ts, summary.spec.ts}`
- 유틸: `e2e-playwright/utils/{storage.ts, overflowInspector.ts, paths.ts}`
- 리더 뷰: `app/views/courses/readers/show.html.erb`
- 플레이어 뷰: `app/views/courses/watch.html.erb`



