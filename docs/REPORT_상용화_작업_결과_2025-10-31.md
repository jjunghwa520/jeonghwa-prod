### 정화의서재 상용화 작업 결과 보고서 (2025-10-31)

- **서비스**: Cloud Run `jeonghwa-app` (region: `asia-northeast1`)
- **도메인**: `정화의서재.kr`, `www.정화의서재.kr` (모두 SSL/Ready=True)
- **프로젝트**: `jeonghwa-prod`
- **최신 리비전(현재)**: `jeonghwa-app-00021-dkv`(예: Hello 이미지 기준)

---

### 1) 도메인/인증서 현황
- Cloud Run Domain Mapping 상태
  - `정화의서재.kr`: Ready=True, CertificateProvisioned=True, DomainRoutable=True
  - `www.정화의서재.kr`: Ready=True, CertificateProvisioned=True, DomainRoutable=True
- Cloudflare DNS(모두 DNS only)
  - A: 216.239.32.21 / 34.21 / 36.21 / 38.21
  - AAAA: 2001:4860:4802:32::15 / 34::15 / 36::15
  - CNAME(WWW): ghs.googlehosted.com.
  - CAA(@): issue=pki.goog, issuewild=pki.goog (+ 기타 CA 다중 허용)

검증 명령
```bash
# 인증서/준비 상태
gcloud beta run domain-mappings describe --domain xn--2i4b17iihloh20d.kr --region asia-northeast1 \
  --format='table(status.conditions[].type,status.conditions[].status,status.conditions[].message)'

gcloud beta run domain-mappings describe --domain www.xn--2i4b17iihloh20d.kr --region asia-northeast1 \
  --format='table(status.conditions[].type,status.conditions[].status,status.conditions[].message)'
```

---

### 2) 인프라/런타임 구성
- Cloud Run `jeonghwa-app` (allow-unauthenticated, ingress=all)
- 버킷: `jh-prod-assets-296627717123` (Uniform ACL, 런타임 SA에 roles/storage.objectAdmin 부여)
- 조직 정책상 서비스계정 키 생성 금지 → `gcp-credentials-json` 미사용(제거). Application Default Credentials(ADC)로 런타임 SA 권한만으로 GCS 접근.
- Secret Manager(최신 버전 참조)
  - `secret-key-base`: 랜덤 생성
  - `database-url`: Cloud SQL 접속 문자열(Unix socket 경로 포함)
  - `toss-client-key`, `toss-secret-key`, `toss-webhook-secret`: 테스트 키 등록 완료
- Cloud SQL(PostgreSQL 15)
  - 인스턴스: `jh-postgres` (state=RUNNABLE)
  - DB/유저: `appdb` / `appuser` (비밀번호 랜덤)
  - Cloud Run에 `roles/cloudsql.client` 및 인스턴스 연결 추가 완료

---

### 3) 현재 배포 상태
- 서비스는 현재 **Hello 컨테이너**가 100% 트래픽을 서빙 중(도메인/인증서 안정화 목적).
- 실제 Rails 앱 배포는 다음 단계에서 진행 필요(A/B 중 택1).

배포 명령(A/B 중 택1)
```bash
# A. 이미지로 배포(이미지 경로가 있는 경우)
IMAGE="asia-northeast1-docker.pkg.dev/${PROJECT}/cloud-run-source-deploy/jeonghwa-app:latest" # 경로 교체
gcloud run deploy jeonghwa-app --region asia-northeast1 \
  --image "$IMAGE" --allow-unauthenticated --timeout=900

# B. 소스에서 빌드/배포(이미지 없음)
# git clone <REPO_URL> && cd <repo_root>  # 예: cd kicda-jh
gcloud run deploy jeonghwa-app --region asia-northeast1 \
  --source . --allow-unauthenticated --timeout=1800
```

---

### 4) 마이그레이션(Job) 실행 계획
- 이전 실패 원인: 서비스 이미지가 Hello 컨테이너(rails 명령 없음). 실제 앱 이미지 배포 후 재시도 필요.
```bash
REGION=asia-northeast1
SERVICE=jeonghwa-app
REV=$(gcloud run services describe "$SERVICE" --region "$REGION" \
  --format='value(status.latestReadyRevisionName)')
IMAGE=$(gcloud run revisions describe "$REV" --region "$REGION" \
  --format='value(spec.containers[0].image)')

gcloud run jobs delete rails-migrate --region "$REGION" --quiet 2>/dev/null || true

gcloud run jobs create rails-migrate --region "$REGION" \
  --image "$IMAGE" \
  --set-secrets SECRET_KEY_BASE=secret-key-base:latest,\
DATABASE_URL=database-url:latest,\
TOSS_SECRET_KEY=toss-secret-key:latest,\
TOSS_CLIENT_KEY=toss-client-key:latest,\
TOSS_WEBHOOK_SECRET=toss-webhook-secret:latest \
  --set-env-vars RAILS_ENV=production,GCS_BUCKET="jh-prod-assets-296627717123" \
  --service-account "${PRJNUM}-compute@developer.gserviceaccount.com" \
  --command /bin/bash --args "-lc","bin/rails db:migrate"

gcloud run jobs execute rails-migrate --region "$REGION" --wait
```

---

### 5) 토스페이먼츠 심사용 체크리스트
- 사이트 접속: 200 응답 (`https://정화의서재.kr`, `https://www.정화의서재.kr`)
- 결제 플로우 페이지 노출(테스트 키)
- 웹훅 엔드포인트: `POST /payments/webhook` (200/204)
- 성공/실패 리다이렉트 URL 본 도메인으로 설정
- 심사 후 운영 전환: Secret Manager에 live 키 버전 추가 → 서비스는 최신 버전 참조로 자동 반영(필요 시 재배포)

---

### 6) 위험요소/롤백
- 배포 실패 시 최신 Ready 리비전에 전환
```bash
gcloud run services update-traffic jeonghwa-app --region asia-northeast1 --to-latest
# 또는 특정 리비전 고정
# gcloud run services update-traffic jeonghwa-app --region asia-northeast1 --to-revisions <REV>=100
```
- 도메인 이슈 시: Cloud Run 도메인 매핑 describe로 상태/메시지 확인, 필요 시 삭제/재생성

---

### 7) 즉시 실행 스모크
```bash
curl -I https://정화의서재.kr
curl -I https://www.정화의서재.kr
curl -I https://정화의서재.kr/payments/webhook
```

---

### 8) 다음 단계(요약)
- 실제 Rails 앱 컨테이너 배포(A/B 중 택1)
- 마이그레이션 Job 실행(실제 이미지로)
- 결제 테스트 페이지로 토스 심사 통과 확인
- 필요 시 CI/CD, 모니터링(Sentry/Logging) 활성화

참고 문서
- `docs/HANDOVER_E2E_상용화_진단_2025-10-25.md`
- `docs/GCP_상용_배포_최초_가이드.md`
- `docs/NEXT_STEPS_2025-10-25.md`
