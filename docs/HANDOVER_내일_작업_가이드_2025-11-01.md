### 내일 작업 가이드 & 인수인계서 (2025-11-01)

#### 목적
- 실제 Rails 앱을 Cloud Run에 배포하고, DB 마이그레이션과 토스 결제 심사를 통과한다.

---

### 0) 오늘까지 상태 요약
- 도메인: `정화의서재.kr` / `www.정화의서재.kr` SSL/Ready=True (Cloudflare DNS only)
- Cloud Run: `jeonghwa-app` 정상(현재 Hello 이미지)
- Secret Manager: `secret-key-base`, `database-url`, `toss-client-key`, `toss-secret-key`, `toss-webhook-secret` 구성 완료
- GCS: `jh-prod-assets-296627717123` 버킷 사용, 런타임 SA에 Object Admin 권한
- Cloud SQL: `jh-postgres`(RUNNABLE), `appdb`/`appuser` 생성, Cloud Run 연동 완료

---

### 1) 역할 분담(권장)
- **어시스턴트(자동 실행 위임 가능)**
  - 실제 앱 배포(A/B 중 택1) 수행
  - 마이그레이션 Job 실행 및 로그 확인
  - 스모크 테스트/웹훅 확인/로그 점검
- **사용자(필요 정보 제공)**
  - A 선택 시: 컨테이너 이미지 경로 제공 (Artifact Registry)
  - B 선택 시: Git 리포지토리 URL 제공 및 브랜치 지정
  - 결제 테스트에 쓸 상품/페이지 확인

---

### 2) 실제 앱 배포 (A/B 중 택1)
A. 이미지로 배포(추천: 빠름)
```bash
PROJECT=jeonghwa-prod
REGION=asia-northeast1
SERVICE=jeonghwa-app
IMAGE="asia-northeast1-docker.pkg.dev/${PROJECT}/cloud-run-source-deploy/jeonghwa-app:latest"  # 실제 경로로 교체

gcloud run deploy "$SERVICE" --region "$REGION" \
  --image "$IMAGE" --allow-unauthenticated --timeout=900
```

B. 소스에서 빌드/배포(이미지 없을 때)
```bash
# git clone <REPO_URL>
# cd <repo_root>  # 예: cd kicda-jh

gcloud run deploy jeonghwa-app --region asia-northeast1 \
  --source . --allow-unauthenticated --timeout=1800
```

배포 확인
```bash
gcloud run services describe jeonghwa-app --region asia-northeast1 \
  --format='table(status.latestReadyRevisionName,status.traffic.statuses.percent,status.url)'
```

---

### 3) DB 마이그레이션(Job)
```bash
REGION=asia-northeast1
SERVICE=jeonghwa-app
PRJNUM=$(gcloud projects describe jeonghwa-prod --format='value(projectNumber)')
REV=$(gcloud run services describe "$SERVICE" --region "$REGION" \
  --format='value(status.latestReadyRevisionName)')
IMAGE=$(gcloud run revisions describe "$REV" --region "$REGION" \
  --format='value(spec.containers[0].image)')

gcloud run jobs delete rails-migrate --region "$REGION" --quiet 2>/dev/null || true

gcloud run jobs create rails-migrate --region "$REGION" \
  --image "$IMAGE" \
  --set-secrets SECRET_KEY_BASE=secret-key-base:latest,\
DATABASE_URL=database-url:latest,\
TOSS_SECRET_KEY=toss-secret-key:latest,\
TOSS_CLIENT_KEY=toss-client-key:latest,\
TOSS_WEBHOOK_SECRET=toss-webhook-secret:latest \
  --set-env-vars RAILS_ENV=production,GCS_BUCKET="jh-prod-assets-296627717123" \
  --service-account "${PRJNUM}-compute@developer.gserviceaccount.com" \
  --command /bin/bash --args "-lc","bin/rails db:migrate"

gcloud run jobs execute rails-migrate --region "$REGION" --wait
```

---

### 4) 토스 심사 준비 체크리스트
- 테스트 키로 결제 버튼/페이지 노출
- 결제창 호출 → 승인/실패 플로우 동작
- 웹훅: `POST https://정화의서재.kr/payments/webhook` 200/204 응답
- 성공/실패 리다이렉트 URL 본 도메인으로 설정
- 심사 후 운영 전환: Secret Manager에 live 키 버전 추가 → 필요 시 서비스 재시작 없이 최신 버전 사용(구성에 따라 재배포 최소화)

---

### 5) 스모크/모니터링
```bash
# 도메인 응답
curl -I https://정화의서재.kr
curl -I https://www.정화의서재.kr
# 웹훅 엔드포인트 열림
curl -I https://정화의서재.kr/payments/webhook
```
- 로그: Cloud Logging에서 `resource.type=cloud_run_revision AND resource.labels.service_name=jeonghwa-app`

---

### 6) 롤백/장애 대응
- 최신 Ready 리비전으로 전환
```bash
gcloud run services update-traffic jeonghwa-app --region asia-northeast1 --to-latest
# 또는 특정 리비전 고정
# gcloud run services update-traffic jeonghwa-app --region asia-northeast1 --to-revisions <REV>=100
```
- 도메인 매핑 이슈 시: describe → 필요 시 삭제/재생성

---

### 7) 참고 문서
- `docs/REPORT_상용화_작업_결과_2025-10-31.md`
- `docs/HANDOVER_E2E_상용화_진단_2025-10-25.md`
- `docs/GCP_상용_배포_최초_가이드.md`
- `docs/NEXT_STEPS_2025-10-25.md`

---

### 8) 내일 아침 착수 순서(요약)
1. 배포 방식 결정(A: 이미지 / B: 소스)
2. 실제 앱 배포 후 서비스 Ready 확인
3. 마이그레이션 Job 실행 및 성공 로그 확인
4. 결제 테스트 페이지로 토스 심사 플로우 점검
5. 스모크 완료 후 운영 체크리스트 마무리
